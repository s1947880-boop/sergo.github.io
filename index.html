<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5Б Хаус - Мессенджер</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-messaging-compat.js"></script>
    <!-- Добавляем библиотеку для WebRTC -->
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
        /* === ОБЩИЕ СТИЛИ === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #f7fafc;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-light: #a0aec0;
            --bg-white: #ffffff;
            --bg-gray: #f7fafc;
            --border-color: #e2e8f0;
            --success-color: #48bb78;
            --danger-color: #f56565;
            --warning-color: #ed8936;
            --message-incoming: #edf2f7;
            --message-outgoing: #667eea;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            --stranger-color: #fff5f5;
            --stranger-border: #fed7d7;
        }
        
        .dark-theme {
            --primary-gradient: linear-gradient(135deg, #4c51bf 0%, #6b46c1 100%);
            --primary-color: #4c51bf;
            --primary-dark: #434190;
            --secondary-color: #1a202c;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --text-light: #718096;
            --bg-white: #2d3748;
            --bg-gray: #1a202c;
            --border-color: #4a5568;
            --success-color: #68d391;
            --danger-color: #fc8181;
            --warning-color: #f6ad55;
            --message-incoming: #2d3748;
            --message-outgoing: #4c51bf;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --stranger-color: #422626;
            --stranger-border: #5c2a2a;
        }
        
        body {
            background: var(--primary-gradient);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        /* === ИНТЕРФЕЙС ЗВОНКА - ИСПРАВЛЕННЫЙ === */
        .call-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            transition: all 0.3s ease;
        }
        
        .call-container.hidden {
            display: none;
        }
        
        .call-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            margin: 0 auto 20px;
            border: 5px solid rgba(255, 255, 255, 0.2);
        }
        
        .call-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .call-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .call-status {
            font-size: 16px;
            opacity: 0.8;
        }
        
        .call-status.ringing {
            animation: pulse 1.5s infinite;
        }
        
        .video-container {
            width: 90%;
            max-width: 600px;
            height: 60%;
            margin-bottom: 30px;
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .remote-video {
            width: 100%;
            height: 100%;
            background: #000;
            object-fit: cover;
        }
        
        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 160px;
            background: #000;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid white;
            box-shadow: var(--shadow-lg);
        }
        
        .local-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .audio-only {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius-lg);
        }
        
        .audio-only-icon {
            font-size: 60px;
            color: white;
        }
        
        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .call-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .call-button.accept {
            background: var(--success-color);
            color: white;
        }
        
        .call-button.decline {
            background: var(--danger-color);
            color: white;
        }
        
        .call-button.mute {
            background: var(--warning-color);
            color: white;
        }
        
        .call-button.video-toggle {
            background: var(--primary-color);
            color: white;
        }
        
        .call-button.end-call {
            background: var(--danger-color);
            color: white;
        }
        
        .call-button:hover {
            transform: scale(1.1);
        }
        
        .call-button.active {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }
        
        .call-duration {
            font-size: 20px;
            color: white;
            margin-top: 20px;
            font-family: monospace;
        }
        
        .call-type-selector {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 15px;
            min-width: 200px;
        }
        
        .call-type-selector.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        
        .call-type-btn {
            padding: 15px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
        }
        
        .call-type-btn.video {
            background: var(--primary-color);
            color: white;
        }
        
        .call-type-btn.audio {
            background: var(--success-color);
            color: white;
        }
        
        .call-type-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Анимация пульсации */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Кнопка звонка в чате */
        .call-chat-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--success-color);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .call-chat-button:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }
        
        /* Остальные стили остаются без изменений, добавляем только вышеуказанные */

        /* === ЭКРАН АУТЕНТИФИКАЦИИ === */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .auth-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .dark-theme .auth-logo h1 {
            background: linear-gradient(135deg, #4c51bf 0%, #6b46c1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .auth-logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 22px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input, 
        .form-group select {
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            background: var(--bg-gray);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: var(--bg-white);
        }
        
        .dark-theme .form-group input:focus,
        .dark-theme .form-group select:focus {
            box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.3);
        }
        
        .form-group small {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            text-decoration: none;
            user-select: none;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.95;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--bg-gray);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--border-color);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        .auth-links {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .auth-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
        }
        
        .auth-links a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        
        .warning-box {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: var(--radius-md);
            padding: 12px 16px;
            margin: 15px 0;
            color: #c53030;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dark-theme .warning-box {
            background: rgba(197, 48, 48, 0.1);
            border-color: rgba(197, 48, 48, 0.3);
            color: #fc8181;
        }
        
        .info-box {
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: var(--radius-md);
            padding: 12px 16px;
            margin: 15px 0;
            color: #2b6cb0;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dark-theme .info-box {
            background: rgba(43, 108, 176, 0.1);
            border-color: rgba(43, 108, 176, 0.3);
            color: #63b3ed;
        }
        
        .auth-hidden {
            display: none;
        }
        
        /* === ОСНОВНОЕ ПРИЛОЖЕНИЕ === */
        .app-container {
            height: 100vh;
            width: 100%;
            position: relative;
            overflow: hidden;
            display: none;
        }
        
        .app-container.active {
            display: block;
        }
        
        /* Экран контактов */
        .contacts-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        /* Заголовок с данными аккаунта */
        .app-header {
            background: var(--primary-gradient);
            padding: 12px 16px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar-large {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .avatar-large:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
        }
        
        .avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .avatar-large.has-photo img {
            display: block;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .user-status {
            font-size: 13px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            background: var(--success-color);
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-button {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            user-select: none;
        }
        
        .icon-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        /* Поиск контактов */
        .search-section {
            padding: 16px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }
        
        .search-container {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 16px;
            z-index: 2;
            pointer-events: none;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 14px 14px 40px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            background: var(--bg-gray);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            z-index: 1;
            user-select: none;
        }
        
        /* Кнопка активации поиска */
        .search-activator {
            position: absolute;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            z-index: 3;
        }
        
        .search-activator.active {
            display: none;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: var(--bg-white);
        }
        
        .dark-theme .search-input:focus {
            box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.3);
        }
        
        .add-contact-btn {
            padding: 14px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
            user-select: none;
        }
        
        .add-contact-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        /* Переключатель Группы/Контакты */
        .tabs-container {
            display: flex;
            background: var(--bg-white);
            padding: 0 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab-button {
            flex: 1;
            padding: 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .tab-button.active {
            color: var(--primary-color);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: var(--primary-color);
            border-radius: var(--radius-full);
        }
        
        /* Список контактов */
        .contacts-list {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-gray);
            padding: 8px;
        }
        
        .contact-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-white);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            user-select: none;
            position: relative;
        }
        
        .contact-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-color);
        }
        
        .contact-card.active {
            background: var(--primary-color);
            color: white;
        }
        
        .contact-card.active .contact-info p {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .contact-card.stranger {
            background: var(--stranger-color);
            border: 1px solid var(--stranger-border);
            animation: strangerPulse 2s infinite;
        }
        
        @keyframes strangerPulse {
            0% { border-color: var(--stranger-border); }
            50% { border-color: var(--danger-color); }
            100% { border-color: var(--stranger-border); }
        }
        
        .stranger-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            border: 2px solid var(--bg-white);
        }
        
        .contact-avatar {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 600;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .contact-avatar.has-photo img {
            display: block;
        }
        
        .dark-theme .contact-avatar {
            background: linear-gradient(135deg, #4c51bf 0%, #6b46c1 100%);
        }
        
        .group-avatar {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .dark-theme .group-avatar {
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
        }
        
        .online-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
            background: var(--success-color);
            border: 2px solid var(--bg-white);
        }
        
        .contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .contact-info h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-info p {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .last-message-time {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        .unread-badge {
            background: var(--primary-color);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            min-width: 20px;
            text-align: center;
        }
        
        /* УВЕДОМЛЕНИЕ НЕЗНАКОМЦА В СПИСКЕ КОНТАКТОВ */
        .stranger-notification {
            background: var(--stranger-color);
            border: 2px solid var(--stranger-border);
            border-radius: var(--radius-md);
            padding: 12px;
            margin: 8px 0;
            position: relative;
            animation: slideIn 0.3s ease;
        }
        
        .stranger-notification-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .stranger-notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stranger-notification-header span {
            font-size: 20px;
        }
        
        .stranger-notification-text {
            flex: 1;
        }
        
        .stranger-notification-text strong {
            display: block;
            margin-bottom: 4px;
        }
        
        .stranger-notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stranger-notification-actions .btn {
            flex: 1;
            padding: 10px;
            font-size: 13px;
        }
        
        /* Экран чата */
        .chat-screen {
            position: absolute;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
            z-index: 20;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .chat-screen.active {
            transform: translateX(-100%);
        }
        
        /* Заголовок чата */
        .chat-header {
            background: var(--primary-gradient);
            padding: 12px 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }
        
        .back-button {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            user-select: none;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        
        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .chat-avatar.has-photo img {
            display: block;
        }
        
        .chat-title {
            flex: 1;
            min-width: 0;
        }
        
        .chat-title h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-status {
            font-size: 13px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Сообщения */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-gray);
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 70px;
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            position: relative;
            animation: messageAppear 0.2s ease;
            word-wrap: break-word;
            line-height: 1.4;
            user-select: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 4px 0;
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-incoming {
            background: var(--message-incoming);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }
        
        .message-outgoing {
            background: var(--message-outgoing);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: var(--radius-sm);
        }
        
        /* РАСШИРЕННОЕ СООБЩЕНИЕ - ИСПРАВЛЕННЫЕ СТИЛИ */
        .message-bubble.expanded {
            transform: none !important;
            z-index: 50;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            margin: 10px 0 !important;
            position: relative;
        }
        
        .dark-theme .message-bubble.expanded {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Исправление для мобильных устройств */
        @media (max-width: 767px) {
            .message-bubble.expanded {
                margin: 5px 0 !important;
            }
        }
        
        .message-expanded-content {
            display: none;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 10px;
        }
        
        .message-bubble.expanded .message-expanded-content {
            display: block;
        }
        
        .message-incoming .message-expanded-content {
            border-top-color: rgba(0, 0, 0, 0.1);
        }
        
        .message-expanded-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .message-action-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .delete-message-btn {
            background: var(--danger-color);
            box-shadow: 0 2px 5px rgba(245, 101, 101, 0.3);
        }
        
        .edit-message-btn {
            background: var(--warning-color);
            box-shadow: 0 2px 5px rgba(237, 137, 54, 0.3);
        }
        
        .forward-message-btn {
            background: var(--primary-color);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }
        
        .copy-message-btn {
            background: var(--success-color);
            box-shadow: 0 2px 5px rgba(72, 187, 120, 0.3);
        }
        
        .reply-message-btn {
            background: var(--success-color);
            box-shadow: 0 2px 5px rgba(72, 187, 120, 0.3);
        }
        
        .message-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        .delete-message-btn:hover {
            background: #e53e3e;
        }
        
        .edit-message-btn:hover {
            background: #dd6b20;
        }
        
        .forward-message-btn:hover {
            background: #5a67d8;
        }
        
        .copy-message-btn:hover {
            background: #38a169;
        }
        
        .reply-message-btn:hover {
            background: #38a169;
        }
        
        .message-action-btn .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            margin-bottom: 5px;
        }
        
        .message-action-btn:hover .tooltip {
            opacity: 1;
        }
        
        .message-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        
        .message-text {
            font-size: 15px;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
            text-align: right;
        }
        
        .message-status {
            display: inline-flex;
            align-items: center;
            margin-left: 4px;
            font-size: 10px;
        }
        
        /* Сообщение с ответом */
        .reply-preview {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--primary-color);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        
        .reply-sender {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        
        .reply-text {
            font-size: 13px;
            opacity: 0.9;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .message-incoming .reply-preview {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .message-incoming .reply-sender {
            color: var(--text-primary);
        }
        
        /* Медиа сообщения */
        .media-message {
            max-width: 280px;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin: 4px 0;
            position: relative;
            cursor: pointer;
        }
        
        .media-image {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .media-image:hover {
            transform: scale(1.02);
        }
        
        /* ГОЛОСОВЫЕ СООБЩЕНИЯ - ИСПРАВЛЕННЫЕ */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            min-width: 200px;
            max-width: 300px;
            position: relative;
            cursor: pointer;
        }
        
        .message-outgoing .voice-message {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .message-incoming .voice-message {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .voice-play-button {
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .message-outgoing .voice-play-button {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary-color);
        }
        
        .voice-play-button:hover {
            transform: scale(1.05);
        }
        
        .voice-play-button.playing {
            background: var(--danger-color);
        }
        
        .message-outgoing .voice-play-button.playing {
            background: var(--danger-color);
            color: white;
        }
        
        .voice-play-icon {
            font-size: 16px;
            margin-left: 2px;
        }
        
        .voice-play-icon.pause {
            font-size: 14px;
        }
        
        .voice-info {
            flex: 1;
            min-width: 0;
        }
        
        .voice-waveform {
            position: relative;
            height: 30px;
            margin-bottom: 4px;
            overflow: hidden;
        }
        
        .voice-wave {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .wave-bar {
            flex: 1;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 1px;
            transition: height 0.3s ease;
        }
        
        .message-incoming .wave-bar {
            background: rgba(0, 0, 0, 0.2);
        }
        
        .wave-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            transition: width 0.1s linear;
            z-index: 1;
        }
        
        .message-incoming .wave-progress {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .voice-duration {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .message-incoming .voice-duration {
            color: var(--text-secondary);
        }
        
        .message-outgoing .voice-duration {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .current-time {
            font-weight: 600;
        }
        
        /* Поле ввода сообщений */
        .message-input-container {
            padding: 12px 16px;
            background: var(--bg-white);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            width: 100%;
            min-height: 60px;
            box-sizing: border-box;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            transition: bottom 0.3s ease;
        }
        
        .message-input-container.active {
            display: flex;
        }
        
        .dark-theme .message-input-container {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .input-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .action-button {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--bg-gray);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            user-select: none;
        }
        
        .action-button:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .action-button.active {
            background: var(--primary-color);
            color: white;
        }
        
        .message-input-wrapper {
            flex: 1;
            background: var(--bg-gray);
            border-radius: var(--radius-full);
            padding: 4px 8px;
            display: flex;
            align-items: center;
            min-height: 40px;
            max-height: 120px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .message-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
            background: var(--bg-white);
        }
        
        .dark-theme .message-input-wrapper:focus-within {
            box-shadow: 0 0 0 2px rgba(76, 81, 191, 0.3);
        }
        
        .message-input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 15px;
            min-height: 32px;
            resize: none;
            max-height: 100px;
            outline: none;
            font-family: inherit;
            line-height: 1.4;
            user-select: none;
        }
        
        .message-input::placeholder {
            color: var(--text-light);
        }
        
        .send-button {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: 4px;
            user-select: none;
        }
        
        .send-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .send-button:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }
        
        /* Панель смайликов и стикеров */
        .emoji-sticker-panel {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border-top: 1px solid var(--border-color);
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            z-index: 999;
        }
        
        .emoji-sticker-panel.active {
            display: block;
            animation: slideUp 0.2s ease;
        }
        
        .emoji-category {
            margin-bottom: 16px;
        }
        
        .emoji-category h4 {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }
        
        .emoji-item {
            font-size: 24px;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .emoji-item:hover {
            background: var(--bg-gray);
            transform: scale(1.1);
        }
        
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .sticker-item {
            font-size: 40px;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            border-radius: var(--radius-md);
            background: var(--bg-gray);
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .sticker-item:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }
        
        /* Индикатор печатания */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--message-incoming);
            border-radius: var(--radius-full);
            margin: 8px 0;
            align-self: flex-start;
            max-width: 120px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: var(--radius-full);
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-white);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 320px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-success {
            border-left-color: var(--success-color);
        }
        
        .notification-error {
            border-left-color: var(--danger-color);
        }
        
        .notification-warning {
            border-left-color: var(--warning-color);
        }
        
        .notification-icon {
            font-size: 20px;
        }
        
        .notification-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-full);
        }
        
        .notification-close:hover {
            background: var(--bg-gray);
            color: var(--text-primary);
        }
        
        /* Пустой список */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .empty-subtext {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .empty-action {
            margin-top: 16px;
        }
        
        /* Загрузка */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: var(--text-light);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Экран настроек */
        .settings-screen {
            position: absolute;
            top: 0;
            left: 100%;
            width: 100%;
            height: 100%;
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
            z-index: 30;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .settings-screen.active {
            transform: translateX(-100%);
        }
        
        .settings-header {
            background: var(--primary-gradient);
            padding: 12px 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-md);
        }
        
        .settings-title {
            font-size: 20px;
            font-weight: 600;
            flex: 1;
        }
        
        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-gray);
        }
        
        .settings-section {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .settings-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-color);
            border-radius: var(--radius-sm);
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-info {
            flex: 1;
        }
        
        .setting-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .setting-description {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--bg-gray);
            border-radius: var(--radius-full);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: var(--primary-gradient);
            border-radius: var(--radius-full);
            transition: all 0.3s ease;
        }
        
        .dark-theme .theme-toggle::after {
            left: 33px;
        }
        
        .photo-upload-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .photo-upload-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            overflow: hidden;
            border: 3px solid var(--border-color);
            margin: 0 auto 20px;
            position: relative;
            cursor: pointer;
        }
        
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .photo-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .photo-action-btn.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .photo-action-btn.secondary {
            background: var(--bg-gray);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .photo-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        /* Кнопка выхода в настройках */
        .logout-section {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        /* ИНТЕРФЕЙС ЗАПИСИ ГОЛОСОВЫХ СООБЩЕНИЙ - УВЕЛИЧЕН Z-INDEX */
        .voice-recording-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(5px);
        }
        
        .voice-recording-container {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
            text-align: center;
        }
        
        .recording-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }
        
        .recording-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .recording-timer {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--danger-color);
            font-family: monospace;
        }
        
        .recording-wave {
            height: 60px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .recording-wave-bar {
            width: 4px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: wave 1.5s infinite ease-in-out;
        }
        
        .recording-wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .recording-wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .recording-wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .recording-wave-bar:nth-child(5) { animation-delay: 0.4s; }
        .recording-wave-bar:nth-child(6) { animation-delay: 0.5s; }
        .recording-wave-bar:nth-child(7) { animation-delay: 0.6s; }
        
        @keyframes wave {
            0%, 60%, 100% { 
                height: 20px;
                background: var(--primary-color);
            }
            30% { 
                height: 40px;
                background: var(--danger-color);
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .recording-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .recording-actions button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .cancel-recording {
            background: var(--bg-gray);
            color: var(--text-primary);
        }
        
        .send-recording {
            background: var(--success-color);
            color: white;
        }
        
        /* Модальное окно */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            text-align: center;
        }
        
        .modal-message {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-icon.warning {
            color: var(--warning-color);
        }
        
        .modal-icon.danger {
            color: var(--danger-color);
        }
        
        .modal-icon.info {
            color: var(--primary-color);
        }
        
        .modal-icon.success {
            color: var(--success-color);
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-actions button {
            flex: 1;
        }
        
        /* Специальные модальные окна */
        .confirm-modal .modal {
            max-width: 350px;
        }
        
        .recover-modal .modal {
            max-width: 450px;
        }
        
        /* Стили для поля ввода домашнего задания */
        .deepseek-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-gray);
            color: var(--text-primary);
            font-size: 15px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }
        
        .deepseek-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: var(--bg-white);
        }
        
        .dark-theme .deepseek-input:focus {
            box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.3);
        }
        
        /* Модальное окно пересылки сообщения */
        .forward-modal .modal {
            max-width: 400px;
        }
        
        .forward-contacts-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }
        
        .forward-contact-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .forward-contact-item:last-child {
            border-bottom: none;
        }
        
        .forward-contact-item:hover {
            background: var(--bg-gray);
        }
        
        .forward-contact-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .forward-contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .forward-contact-avatar.has-photo img {
            display: block;
        }
        
        .forward-contact-info {
            flex: 1;
        }
        
        .forward-contact-name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .forward-contact-username {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Модальное окно редактирования сообщения */
        .edit-modal .modal {
            max-width: 400px;
        }
        
        .edit-message-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-gray);
            color: var(--text-primary);
            font-size: 15px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .edit-message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: var(--bg-white);
        }
        
        /* Модальное окно копирования сообщения */
        .copy-modal .modal {
            max-width: 350px;
        }
        
        /* Фуллскрин просмотр фото */
        .fullscreen-photo-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }
        
        .fullscreen-photo-container {
            position: relative;
            width: 90%;
            height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .fullscreen-photo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .fullscreen-photo-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .fullscreen-photo-close:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        /* Красивое меню */
        .chat-menu {
            position: absolute;
            top: 60px;
            right: 16px;
            background: var(--bg-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
            display: none;
        }
        
        .chat-menu.active {
            display: block;
            animation: slideDown 0.2s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:hover {
            background: var(--bg-gray);
        }
        
        .menu-item.delete {
            color: var(--danger-color);
        }
        
        /* Админ панель - ИСПРАВЛЕННАЯ (без бана/разбана) */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-white);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .admin-tab {
            padding: 10px 20px;
            background: var(--bg-gray);
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .admin-tab.active {
            background: var(--primary-color);
            color: white;
        }
        
        .admin-tab:hover {
            background: var(--border-color);
        }
        
        .admin-tab.active:hover {
            background: var(--primary-dark);
        }
        
        .admin-section {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .admin-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg-gray);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }
        
        .user-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .user-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        
        .user-item-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .user-item-avatar.has-photo img {
            display: block;
        }
        
        .user-item-details h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .user-item-details p {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-status-badge {
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-active {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success-color);
        }
        
        .status-deleted {
            background: rgba(160, 174, 192, 0.1);
            color: var(--text-light);
        }
        
        .status-group {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .admin-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .admin-btn.delete {
            background: #fed7d7;
            color: #c53030;
        }
        
        .admin-btn.restore {
            background: #bee3f8;
            color: #2a4365;
        }
        
        .admin-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .admin-message-item {
            padding: 15px;
            background: var(--bg-gray);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }
        
        .admin-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .admin-message-sender {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .admin-message-time {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .admin-message-content {
            margin-bottom: 10px;
        }
        
        .admin-message-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        /* === УГОЛОК УЧЕНИКА === */
        .student-corner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        
        .student-corner-container {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            width: 100%;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .student-corner-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .student-corner-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .student-corner-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .student-corner-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .schedule-section {
            background: var(--bg-gray);
            border-radius: var(--radius-md);
            padding: 20px;
        }
        
        .schedule-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .schedule-section h3::before {
            content: '📚';
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .schedule-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 767px) {
            .schedule-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .day-schedule {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .day-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .day-header::before {
            content: '📅';
        }
        
        .lessons-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .lesson-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg-gray);
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        
        .lesson-item:hover {
            background: var(--border-color);
            transform: translateX(5px);
        }
        
        .lesson-item.with-homework {
            border-left: 4px solid var(--primary-color);
        }
        
        .lesson-item.completed {
            background: rgba(72, 187, 120, 0.1);
            border-left: 4px solid var(--success-color);
        }
        
        .homework-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            color: white;
        }
        
        .completed-indicator {
            position: absolute;
            top: 5px;
            right: 30px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: var(--radius-full);
            background: var(--success-color);
            color: white;
        }
        
        .lesson-number {
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .lesson-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .student-corner-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        /* Адаптивность */
        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
                margin: 0 auto;
                height: 90vh;
                margin-top: 5vh;
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: var(--shadow-lg);
            }
            
            .contacts-screen,
            .chat-screen,
            .settings-screen {
                border-radius: var(--radius-lg);
            }
        }
        
        @media (max-width: 767px) {
            .messages-container {
                padding-bottom: 70px;
                transition: padding-bottom 0.3s ease;
            }
            
            .fullscreen-photo-container {
                width: 95%;
                height: 80%;
            }
            
            .student-corner-container {
                padding: 20px;
                max-height: 85vh;
            }
            
            .schedule-grid {
                grid-template-columns: 1fr;
            }
            
            /* Улучшение видимости при открытой клавиатуре */
            .keyboard-open .messages-container {
                padding-bottom: 150px;
            }
            
            .keyboard-open .message-input-container {
                bottom: 0;
                z-index: 1000;
            }
        }
        
        /* Стили для поддержки безопасных областей на iOS */
        @supports (-webkit-touch-callout: none) {
            .message-input-container {
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }
            
            .messages-container {
                padding-bottom: max(70px, env(safe-area-inset-bottom) + 60px);
            }
        }
        
        /* Улучшенная поддержка высоты на мобильных устройствах */
        .mobile-keyboard-open .messages-container {
            max-height: 60vh !important;
            overflow-y: scroll !important;
        }
        
        /* Стили для уведомлений Web Push */
        .push-notification-permission {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--primary-gradient);
            color: white;
            padding: 15px;
            border-radius: var(--radius-lg);
            z-index: 2000;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }
        
        .push-notification-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .push-notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .push-notification-actions {
            display: flex;
            gap: 10px;
        }
        
        .push-notification-actions .btn {
            flex: 1;
            padding: 10px;
        }
        
        .push-notification-actions .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .push-notification-actions .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Индикатор реплая */
        .reply-indicator {
            background: var(--bg-gray);
            padding: 10px 16px;
            border-left: 3px solid var(--primary-color);
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reply-info {
            flex: 1;
        }
        
        .reply-to {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .reply-preview-text {
            font-size: 14px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .cancel-reply-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .cancel-reply-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        /* Стили для кнопки пересылки в кружке - ИСПРАВЛЕНО, РАСПОЛОЖЕНИЕ С КНОПКАМИ РЕДАКТИРОВАНИЯ/УДАЛЕНИЯ */
        .forward-circle-btn {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .forward-circle-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        /* Стили для кнопки копирования сообщения */
        .copy-message-circle-btn {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: var(--radius-full);
            background: var(--success-color);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .copy-message-circle-btn:hover {
            background: #38a169;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- === ЭКРАН АУТЕНТИФИКАЦИИ === -->
    <div class="auth-container" id="authContainer">
        <!-- Форма входа -->
        <div class="auth-card" id="loginForm">
            <div class="auth-logo">
                <h1>5Б Хаус</h1>
                <p>Мессенджер для общения класса</p>
            </div>
            
            <h2>Вход в аккаунт</h2>
            
            <div class="auth-form" id="loginFormContent">
                <div class="form-group">
                    <label for="loginUsername">Никнейм</label>
                    <input type="text" 
                           id="loginUsername" 
                           placeholder="Введите ваш никнейм"
                           required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Пароль</label>
                    <input type="password" 
                           id="loginPassword" 
                           placeholder="Введите ваш пароль"
                           required>
                </div>
                
                <button class="btn btn-primary" id="loginBtn">
                    Войти
                </button>
            </div>
            
            <div class="auth-links">
                <a href="#" id="forgotPasswordLink">Забыли пароль?</a>
            </div>
            
            <div class="auth-switch">
                Нет аккаунта?
                <a href="#" id="showRegisterLink">Зарегистрироваться</a>
            </div>
        </div>
        
        <!-- Форма регистрации -->
        <div class="auth-card auth-hidden" id="registerForm">
            <div class="auth-logo">
                <h1>Регистрация</h1>
                <p>Создайте новый аккаунт</p>
            </div>
            
            <h2>Создание аккаунта</h2>
            
            <div class="auth-form" id="registerFormContent">
                <div class="form-group">
                    <label for="registerUsername">Никнейм</label>
                    <input type="text" 
                           id="registerUsername" 
                           placeholder="Придумайте никнейм"
                           required>
                    <small>Будет использоваться для входа</small>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Пароль</label>
                    <input type="password" 
                           id="registerPassword" 
                           placeholder="Придумайте пароль"
                           required>
                </div>
                
                <div class="form-group">
                    <label for="registerName">Имя</label>
                    <input type="text" 
                           id="registerName" 
                           placeholder="Ваше имя"
                           required>
                    <small>Как вас будут видеть другие пользователи</small>
                </div>
                
                <div class="form-group">
                    <label for="registerSecretWord">Кодовое слово</label>
                    <input type="password" 
                           id="registerSecretWord" 
                           placeholder="Придумайте кодовое слово"
                           required>
                    <small>Используется для восстановления пароля (минимум 4 символа)</small>
                </div>
                
                <div class="info-box">
                    ⚠️ Для восстановления пароля понадобится никнейм и кодовое слово
                </div>
                
                <button class="btn btn-primary" id="registerBtn">
                    Зарегистрироваться
                </button>
            </div>
            
            <div class="auth-switch">
                Уже есть аккаунт?
                <a href="#" id="showLoginLink">Войти</a>
            </div>
        </div>
        
        <!-- Форма восстановления пароля -->
        <div class="auth-card auth-hidden" id="recoverForm">
            <div class="auth-logo">
                <h1>Восстановление</h1>
                <p>Восстановите доступ к аккаунту</p>
            </div>
            
            <h2>Восстановление пароля</h2>
            
            <div class="auth-form" id="recoverFormContent">
                <div class="warning-box">
                    ⚠️ Для восстановления пароля необходимо знать кодовое слово
                </div>
                
                <div class="form-group">
                    <label for="recoverUsername">Никнейм</label>
                    <input type="text" 
                           id="recoverUsername" 
                           placeholder="Введите ваш никнейм"
                           required>
                </div>
                
                <div class="form-group">
                    <label for="recoverSecretWord">Кодовое слово</label>
                    <input type="password" 
                           id="recoverSecretWord" 
                           placeholder="Введите кодовое слово"
                           required>
                </div>
                
                <div class="form-group">
                    <label for="recoverNewPassword">Новый пароль</label>
                    <input type="password" 
                           id="recoverNewPassword" 
                           placeholder="Придумайте новый пароль"
                           required>
                </div>
                
                <button class="btn btn-primary" id="recoverBtn">
                    Восстановить
                </button>
            </div>
            
            <div class="auth-switch">
                <a href="#" id="backToLoginFromRecover">← Назад к входу</a>
            </div>
        </div>
    </div>
    
    <!-- === ОСНОВНОЕ ПРИЛОЖЕНИЕ === -->
    <div class="app-container" id="appContainer">
        <!-- Экран 1: Контакты -->
        <div class="contacts-screen" id="contactsScreen">
            <!-- Заголовок с данными аккаунта -->
            <header class="app-header">
                <div class="user-profile">
                    <div class="avatar-large" id="mobileAvatar">
                        U
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="mobileUserName">Пользователь</div>
                        <div class="user-status">
                            <span class="status-indicator"></span>
                            <span id="mobileUserStatus">Онлайн</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <!-- Кнопка уголка ученика -->
                        <button class="icon-button" id="studentCornerBtn" title="Уголок ученика">
                            📖
                        </button>
                        <!-- Кнопка настроек -->
                        <button class="icon-button" id="mobileSettingsBtn" title="Настройки">
                            ⚙️
                        </button>
                    </div>
                </div>
            </header>

            <!-- Поле поиска и кнопка добавления контакта -->
            <div class="search-section">
                <div class="search-container">
                    <span class="search-icon">🔍</span>
                    <input type="text" 
                           class="search-input" 
                           id="mobileSearchInput" 
                           placeholder="Поиск контактов или групп..."
                           readonly>
                    <button class="search-activator" id="searchActivator"></button>
                </div>
                <button class="add-contact-btn" id="addContactBtn">
                    <span>+</span> Добавить контакт
                </button>
            </div>

            <!-- Переключатель Группы/Контакты -->
            <div class="tabs-container">
                <button class="tab-button active" data-tab="groups">
                    👥 Группы
                </button>
                <button class="tab-button" data-tab="contacts">
                    👤 Контакты
                </button>
            </div>

            <!-- Список контактов/групп -->
            <div class="contacts-list" id="mobileContactsList">
                <div class="loading">
                    <div class="spinner"></div>
                    Загрузка контактов...
                </div>
            </div>
        </div>

        <!-- Экран 2: Чат -->
        <div class="chat-screen" id="chatScreen">
            <!-- Заголовок чата -->
            <header class="chat-header">
                <button class="back-button" id="backToContactsBtn" title="Назад">
                    ←
                </button>
                <div class="chat-info">
                    <div class="chat-avatar" id="chatAvatar">
                        G
                    </div>
                    <div class="chat-title">
                        <h3 id="chatTitle">Выберите чат</h3>
                        <div class="chat-status">
                            <span id="chatStatusText">Не в сети</span>
                        </div>
                    </div>
                </div>
                <button class="icon-button" id="chatMenuBtn" title="Меню чата">
                    ⋮
                </button>
                <!-- Кнопка звонка в чате -->
                <button class="icon-button" id="callChatButton" title="Позвонить">
                    📞
                </button>
            </header>

            <!-- Сообщения -->
            <div class="messages-container" id="mobileMessagesContainer">
                <div class="empty-state">
                    <div class="empty-icon">💬</div>
                    <div class="empty-text">Начните общение!</div>
                    <div class="empty-subtext">Выберите чат из списка</div>
                </div>
            </div>

            <!-- Индикатор реплая -->
            <div class="reply-indicator" id="replyIndicator" style="display: none;">
                <div class="reply-info">
                    <div class="reply-to" id="replyToLabel">Ответ на сообщение</div>
                    <div class="reply-preview-text" id="replyPreviewText"></div>
                </div>
                <button class="cancel-reply-btn" id="cancelReplyBtn">×</button>
            </div>

            <!-- Индикатор печатания -->
            <div class="typing-indicator" id="mobileTypingIndicator" style="display: none;">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span id="typingUserName">печатает...</span>
            </div>

            <!-- Панель смайликов и стикеров -->
            <div class="emoji-sticker-panel" id="emojiStickerPanel">
                <div class="emoji-category" id="emojiSection">
                    <h4>Смайлики</h4>
                    <div class="emoji-grid" id="mobileEmojiGrid">
                        <!-- Emojis will be inserted here -->
                    </div>
                </div>
                <div class="emoji-category" id="stickerSection" style="display: none;">
                    <h4>Стикеры</h4>
                    <div class="sticker-grid" id="mobileStickerGrid">
                        <!-- Stickers will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Меню чата -->
            <div class="chat-menu" id="chatMenu">
                <button class="menu-item" id="chatClearBtn">
                    <span>🗑️</span> Очистить историю чата
                </button>
                <button class="menu-item delete" id="removeFromContactsBtn" style="display: none;">
                    <span>❌</span> Удалить из контактов
                </button>
            </div>
        </div>
        
        <!-- Экран 3: Настройки -->
        <div class="settings-screen" id="settingsScreen">
            <!-- Заголовок настроек -->
            <header class="settings-header">
                <button class="back-button" id="backFromSettingsBtn" title="Назад">
                    ←
                </button>
                <div class="settings-title">Настройки</div>
            </header>

            <!-- Содержимое настроек -->
            <div class="settings-content">
                <!-- Раздел профиля -->
                <div class="settings-section">
                    <h3>Профиль</h3>
                    
                    <div class="photo-preview" id="photoPreview">
                        <img id="photoPreviewImg" src="" alt="Фото профиля">
                    </div>
                    
                    <div class="photo-actions">
                        <button class="photo-action-btn primary" id="uploadPhotoBtn">
                            📷 Выбрать фото
                        </button>
                        <button class="photo-action-btn secondary" id="removePhotoBtn">
                            ❌ Удалить фото
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Имя пользователя</div>
                            <div class="setting-description" id="currentUsername">Загрузка...</div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Имя</div>
                            <div class="setting-description" id="currentName">Загрузка...</div>
                        </div>
                    </div>
                </div>

                <!-- Раздел внешнего вида -->
                <div class="settings-section">
                    <h3>Внешний вид</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Темная тема</div>
                            <div class="setting-description">Включить темную цветовую тему</div>
                        </div>
                        <div class="theme-toggle" id="themeToggleSettings"></div>
                    </div>
                </div>

                <!-- Раздел аккаунта -->
                <div class="settings-section">
                    <h3>Аккаунт</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Изменить кодовое слово</div>
                            <div class="setting-description">Изменить кодовое слово для восстановления</div>
                        </div>
                        <button class="photo-action-btn secondary" id="changeSecretWordBtn">
                            Изменить
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Восстановить удаленный аккаунт</div>
                            <div class="setting-description">Восстановить ранее удаленный аккаунт</div>
                        </div>
                        <button class="photo-action-btn secondary" id="recoverDeletedAccountBtn">
                            Восстановить
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Удалить аккаунт</div>
                            <div class="setting-description">Навсегда удалить аккаунт и все данные</div>
                        </div>
                        <button class="photo-action-btn secondary btn-danger" id="deleteAccountBtn">
                            Удалить
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Выйти из аккаунта</div>
                            <div class="setting-description">Завершить текущую сессию</div>
                        </div>
                        <button class="photo-action-btn secondary" id="logoutBtn">
                            Выйти
                        </button>
                    </div>
                </div>
                
                <!-- АДМИН ПАНЕЛЬ -->
                <div class="settings-section">
                    <h3>Администрация</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Админ панель</div>
                            <div class="setting-description">Доступ к управлению пользователями и сообщениями</div>
                        </div>
                        <button class="photo-action-btn secondary" id="adminPanelBtn">
                            🔒 Открыть
                        </button>
                    </div>
                </div>
                
                <!-- НАСТРОЙКИ УВЕДОМЛЕНИЙ -->
                <div class="settings-section">
                    <h3>Уведомления</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Push-уведомления</div>
                            <div class="setting-description">Получать уведомления о новых сообщениях на компьютере и телефоне</div>
                        </div>
                        <button class="photo-action-btn secondary" id="enableNotificationsBtn">
                            Включить
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Тест уведомлений</div>
                            <div class="setting-description">Отправить тестовое уведомление</div>
                        </div>
                        <button class="photo-action-btn secondary" id="testNotificationBtn">
                            Тест
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Поле ввода сообщений - ТОЛЬКО ДЛЯ ЧАТОВ -->
    <div class="message-input-container" id="globalMessageInput">
        <div class="input-actions">
            <button class="action-button" id="emojiBtnMobile" title="Смайлики">
                😊
            </button>
            <button class="action-button" id="stickerBtnMobile" title="Стикеры">
                🎨
            </button>
            <button class="action-button" id="mediaBtnMobile" title="Медиа">
                📷
            </button>
        </div>
        
        <div class="message-input-wrapper" id="messageInputWrapper">
            <textarea class="message-input" 
                      id="mobileMessageInput" 
                      placeholder="Введите сообщение..."
                      rows="1"></textarea>
            <button class="action-button" id="voiceBtnMobile" title="Голосовое сообщение">
                🎤
            </button>
        </div>
        
        <button class="send-button" id="mobileSendBtn" disabled title="Отправить">
            ↑
        </button>
    </div>

    <!-- Модальные окна -->
    <div id="modalContainer"></div>
    
    <!-- Уголок ученика -->
    <div id="studentCornerModal" style="display: none;"></div>

    <!-- Интерфейс звонка - ИСПРАВЛЕННЫЙ -->
    <div class="call-container hidden" id="callContainer">
        <div class="call-header">
            <div class="call-avatar" id="callAvatar">
                <div id="callAvatarText">U</div>
            </div>
            <div class="call-title" id="callTitle">Звонок</div>
            <div class="call-status" id="callStatus">Соединение...</div>
            <div class="call-duration" id="callDuration">00:00</div>
        </div>
        
        <div class="video-container" id="videoContainer">
            <video class="remote-video" id="remoteVideo" autoplay playsinline></video>
            <div class="local-video" id="localVideoContainer">
                <video id="localVideo" autoplay playsinline muted></video>
            </div>
            <div class="audio-only" id="audioOnlyContainer">
                <div class="audio-only-icon">📞</div>
            </div>
        </div>
        
        <div class="call-controls">
            <button class="call-button mute" id="muteButton" title="Отключить микрофон">
                🎤
            </button>
            <button class="call-button video-toggle" id="videoToggleButton" title="Отключить видео">
                📹
            </button>
            <button class="call-button decline end-call" id="endCallButton" title="Завершить звонок">
                📞
            </button>
        </div>
        
        <div class="call-controls" id="incomingCallControls" style="display: none;">
            <button class="call-button accept" id="acceptCallButton" title="Принять звонок">
                📞
            </button>
            <button class="call-button decline" id="declineCallButton" title="Отклонить звонок">
                📞
            </button>
        </div>
    </div>

    <!-- Выбор типа звонка -->
    <div class="call-type-selector" id="callTypeSelector">
        <button class="call-type-btn video" id="videoCallBtn">
            <span>📹</span> Видеозвонок
        </button>
        <button class="call-type-btn audio" id="audioCallBtn">
            <span>📞</span> Аудиозвонок
        </button>
    </div>

    <!-- Аудио элементы для звуков -->
    <audio id="messageSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" type="audio/mpeg">
    </audio>
    <audio id="callSound" preload="auto" loop>
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-phone-ring-3333.mp3" type="audio/mpeg">
    </audio>
    <audio id="callEndSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-phone-hang-up-909.mp3" type="audio/mpeg">
    </audio>

    <script>
        // === КОНФИГУРАЦИЯ FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDZ3OGbgNW7o3VQh-x9cEKt55B_EBNFEPw",
            authDomain: "b-messenger-c00bf.firebaseapp.com",
            projectId: "b-messenger-c00bf",
            storageBucket: "b-messenger-c00bf.firebasestorage.app",
            messagingSenderId: "559400774703",
            appId: "1:559400774703:web:27a11bef6e6e47fc7b6ada"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let messaging = null;
        
        // Проверяем поддержку Firebase Messaging
        try {
            if (firebase.messaging.isSupported()) {
                messaging = firebase.messaging();
            }
        } catch (error) {
            console.log('Firebase Messaging не поддерживается в этом браузере:', error);
        }

        // Глобальные переменные для звонков - ИСПРАВЛЕННЫЕ
        let peerConnection = null;
        let localStream = null;
        let remoteStream = null;
        let callData = null;
        let callDurationInterval = null;
        let callStartTime = null;
        let isMuted = false;
        let isVideoOff = false;
        let currentCallType = null; // 'video' или 'audio'
        let callState = 'idle'; // 'idle', 'calling', 'ringing', 'connected'
        let incomingCallData = null;
        let callListenerUnsubscribe = null;
        let iceCandidatesToSend = [];
        let iceCandidateInterval = null;
        
        // Глобальные переменные мессенджера
        let currentUser = null;
        let users = [];
        let deletedUsers = JSON.parse(localStorage.getItem('5bHouseDeletedUsers')) || [];
        let contacts = {};
        let messages = {};
        let currentChat = null;
        let currentChatId = null;
        let typingUsers = {};
        let isDarkTheme = localStorage.getItem('5bHouseDarkTheme') === 'true';
        let userPhoto = localStorage.getItem('5bHouseUserPhoto') || null;
        let notificationPermission = localStorage.getItem('5bHouseNotificationPermission') || 'default';
        
        // Переменные для голосовых сообщений
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimer = null;
        let recordingStartTime = null;
        let currentRecordingDuration = 0;
        let audioStream = null;
        
        // Переменные для воспроизведения голосовых сообщений
        let currentPlayingAudio = null;
        let currentPlayingMessageId = null;

        // Переменные для ответа на сообщение
        let replyingToMessageId = null;
        let replyingToMessage = null;

        // Переменные для редактирования сообщения
        let editingMessageId = null;
        let editingMessage = null;

        // Таймеры для удаления уведомлений "Сообщение удалено"
        let deletedMessageTimers = {};

        // Расписание уроков
        const schedule = {
            monday: [
                "РОВ",
                "ИЗО",
                "Математика",
                "История",
                "Русский язык",
                "Литература"
            ],
            tuesday: [
                "Технология",
                "Технология",
                "Информатика/Английский язык",
                "Русский язык",
                "Математика",
                "История"
            ],
            wednesday: [
                "Ф/К",
                "Ф/К",
                "Математика",
                "География",
                "Русский язык",
                "Литература"
            ],
            thursday: [
                "Музыка",
                "Математика",
                "Русский язык",
                "Биология",
                "Английский язык",
                "Литература"
            ],
            friday: [
                "Математика",
                "Информатика/Английский язык",
                "Смысловое чтение",
                "Русский язык",
                "Английский язык",
                "История"
            ]
        };

        // Дни недели на русском
        const daysOfWeek = {
            monday: "Понедельник",
            tuesday: "Вторник",
            wednesday: "Среда",
            thursday: "Четверг",
            friday: "Пятница"
        };

        // Домашние задания (хранятся в localStorage)
        let homeworkData = JSON.parse(localStorage.getItem('5bHouseHomework')) || {};
        
        // Эмодзи и стикеры
        const emojis = [
            '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
            '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
            '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
            '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
            '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬',
            '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗'
        ];

        const stickers = [
            '🎒', '📚', '✏️', '📝', '📖', '🎓', '🏫', '⭐',
            '🏆', '🎯', '📌', '📍', '🔍', '💡', '💎', '🎨'
        ];

        // === ИСПРАВЛЕННЫЕ ФУНКЦИИ ЗВОНКОВ (АВТОМАТИЧЕСКИЕ) ===
        
        function showCallTypeSelector() {
            if (!currentChat || !currentUser) {
                showNotification('Выберите чат для звонка', 'error');
                return;
            }
            
            document.getElementById('callTypeSelector').classList.add('active');
        }
        
        function hideCallTypeSelector() {
            document.getElementById('callTypeSelector').classList.remove('active');
        }
        
        async function startCall(callType) {
            currentCallType = callType;
            
            const contact = users.find(u => u.username === currentChat);
            if (!contact) {
                showNotification('Контакт не найден', 'error');
                return;
            }
            
            if (contact.isGroup) {
                showNotification('Групповые звонки пока не поддерживаются', 'error');
                return;
            }
            
            try {
                // Запрашиваем доступ к медиаустройствам
                const constraints = {
                    audio: true,
                    video: callType === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Создаем соединение WebRTC
                await createPeerConnection();
                
                // Добавляем локальный поток
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Настраиваем интерфейс звонка
                setupCallInterface(contact, 'calling');
                
                // Показываем локальное видео
                if (callType === 'video') {
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('localVideoContainer').style.display = 'block';
                    document.getElementById('audioOnlyContainer').style.display = 'none';
                } else {
                    document.getElementById('localVideoContainer').style.display = 'none';
                    document.getElementById('audioOnlyContainer').style.display = 'flex';
                }
                
                // Создаем предложение
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Сохраняем данные звонка в Firebase
                const callId = Date.now().toString();
                callData = {
                    id: callId,
                    caller: currentUser.username,
                    receiver: contact.username,
                    type: callType,
                    offer: offer,
                    status: 'ringing',
                    createdAt: new Date().toISOString()
                };
                
                await db.collection('calls').doc(callId).set(callData);
                
                // Слушаем изменения в звонке
                setupCallListener(callId);
                
                // Проигрываем звук звонка
                playCallSound();
                
                // Автоматически завершить звонок через 30 секунд, если никто не отвечает
                setTimeout(() => {
                    if (callState === 'calling' || callState === 'ringing') {
                        showNotification('Звонок не принят', 'info');
                        endCall();
                    }
                }, 30000);
                
            } catch (error) {
                console.error('Ошибка начала звонка:', error);
                showNotification('Ошибка начала звонка: ' + error.message, 'error');
                endCall();
            }
        }
        
        function setupCallListener(callId) {
            if (callListenerUnsubscribe) {
                callListenerUnsubscribe();
            }
            
            callListenerUnsubscribe = db.collection('calls').doc(callId).onSnapshot((doc) => {
                if (!doc.exists) return;
                
                const call = doc.data();
                
                if (call.status === 'accepted') {
                    // Звонок принят
                    setupCallInterface(null, 'connected');
                    stopCallSound();
                    
                    if (call.answer) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(call.answer))
                            .catch(error => console.error('Ошибка установки удаленного описания:', error));
                    }
                    
                } else if (call.status === 'declined') {
                    // Звонок отклонен
                    showNotification('Звонок отклонен', 'error');
                    endCall();
                    
                } else if (call.status === 'ended') {
                    // Звонок завершен
                    endCall();
                }
                
                // Получаем ICE кандидаты
                if (call.iceCandidates) {
                    call.iceCandidates.forEach(candidate => {
                        if (candidate && peerConnection) {
                            peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                                .catch(error => console.error('Ошибка добавления ICE кандидата:', error));
                        }
                    });
                }
            }, error => {
                console.error('Ошибка прослушивания звонка:', error);
            });
        }
        
        function setupIncomingCallListener() {
            if (!currentUser) return;
            
            db.collection('calls')
                .where('receiver', '==', currentUser.username)
                .where('status', '==', 'ringing')
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const call = change.doc.data();
                            
                            // Проверяем, не обработали ли мы уже этот звонок
                            if (incomingCallData && incomingCallData.id === call.id) return;
                            
                            incomingCallData = call;
                            
                            // Показываем интерфейс входящего звонка
                            const caller = users.find(u => u.username === call.caller);
                            if (caller) {
                                setupIncomingCallInterface(caller, call);
                                playCallSound();
                            }
                        }
                    });
                }, error => {
                    console.error('Ошибка прослушивания входящих звонков:', error);
                });
        }
        
        function setupCallInterface(contact, state) {
            callState = state;
            
            const callContainer = document.getElementById('callContainer');
            const callTitle = document.getElementById('callTitle');
            const callStatus = document.getElementById('callStatus');
            const callAvatar = document.getElementById('callAvatar');
            const callAvatarText = document.getElementById('callAvatarText');
            const incomingControls = document.getElementById('incomingCallControls');
            const outgoingControls = document.querySelector('.call-controls:not(#incomingCallControls)');
            const callDurationEl = document.getElementById('callDuration');
            
            callContainer.classList.remove('hidden');
            
            if (contact) {
                callTitle.textContent = contact.name;
                callAvatarText.textContent = contact.name.charAt(0).toUpperCase();
                
                if (contact.photo) {
                    callAvatar.innerHTML = `<img src="${contact.photo}" alt="${contact.name}">`;
                    callAvatarText.style.display = 'none';
                } else {
                    callAvatar.innerHTML = `<div id="callAvatarText">${contact.name.charAt(0).toUpperCase()}</div>`;
                }
            }
            
            if (state === 'calling') {
                callStatus.textContent = 'Звонок...';
                callStatus.classList.add('ringing');
                incomingControls.style.display = 'none';
                outgoingControls.style.display = 'flex';
                callDurationEl.style.display = 'none';
                
            } else if (state === 'ringing') {
                callStatus.textContent = 'Входящий звонок...';
                callStatus.classList.add('ringing');
                incomingControls.style.display = 'flex';
                outgoingControls.style.display = 'none';
                callDurationEl.style.display = 'none';
                
            } else if (state === 'connected') {
                callStatus.textContent = 'В разговоре';
                callStatus.classList.remove('ringing');
                incomingControls.style.display = 'none';
                outgoingControls.style.display = 'flex';
                callDurationEl.style.display = 'block';
                
                // Запускаем таймер длительности звонка
                startCallTimer();
            }
        }
        
        function setupIncomingCallInterface(caller, call) {
            setupCallInterface(caller, 'ringing');
            
            // Настраиваем кнопки принятия/отклонения
            document.getElementById('acceptCallButton').onclick = () => acceptCall(call);
            document.getElementById('declineCallButton').onclick = () => declineCall(call);
        }
        
        async function acceptCall(call) {
            try {
                stopCallSound();
                
                // Обновляем статус звонка
                await db.collection('calls').doc(call.id).update({
                    status: 'accepted'
                });
                
                // Получаем доступ к медиаустройствам
                const constraints = {
                    audio: true,
                    video: call.type === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Создаем соединение WebRTC
                await createPeerConnection();
                
                // Добавляем локальный поток
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Устанавливаем удаленное описание
                await peerConnection.setRemoteDescription(new RTCSessionDescription(call.offer));
                
                // Создаем ответ
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Отправляем ответ
                await db.collection('calls').doc(call.id).update({
                    answer: answer,
                    status: 'accepted'
                });
                
                // Настраиваем интерфейс
                setupCallInterface(null, 'connected');
                
                // Показываем локальное видео
                if (call.type === 'video') {
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('localVideoContainer').style.display = 'block';
                    document.getElementById('audioOnlyContainer').style.display = 'none';
                } else {
                    document.getElementById('localVideoContainer').style.display = 'none';
                    document.getElementById('audioOnlyContainer').style.display = 'flex';
                }
                
                incomingCallData = null;
                
            } catch (error) {
                console.error('Ошибка принятия звонка:', error);
                showNotification('Ошибка принятия звонка: ' + error.message, 'error');
                endCall();
            }
        }
        
        async function declineCall(call) {
            try {
                stopCallSound();
                
                await db.collection('calls').doc(call.id).update({
                    status: 'declined'
                });
                
                endCall();
                showNotification('Звонок отклонен', 'info');
                
            } catch (error) {
                console.error('Ошибка отклонения звонка:', error);
                endCall();
            }
        }
        
        async function endCall() {
            // Останавливаем звук звонка
            stopCallSound();
            
            // Проигрываем звук завершения звонка
            playCallEndSound();
            
            // Останавливаем таймер
            if (callDurationInterval) {
                clearInterval(callDurationInterval);
                callDurationInterval = null;
            }
            
            // Закрываем медиапотоки
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            // Закрываем соединение WebRTC
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Отписываемся от слушателя звонка
            if (callListenerUnsubscribe) {
                callListenerUnsubscribe();
                callListenerUnsubscribe = null;
            }
            
            // Очищаем ICE кандидаты
            if (iceCandidateInterval) {
                clearInterval(iceCandidateInterval);
                iceCandidateInterval = null;
            }
            iceCandidatesToSend = [];
            
            // Обновляем статус звонка в Firebase
            if (callData) {
                try {
                    await db.collection('calls').doc(callData.id).update({
                        status: 'ended',
                        endedAt: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Ошибка обновления статуса звонка:', error);
                }
                callData = null;
            }
            
            // Скрываем интерфейс звонка
            document.getElementById('callContainer').classList.add('hidden');
            
            // Сбрасываем состояние
            callState = 'idle';
            currentCallType = null;
            isMuted = false;
            isVideoOff = false;
            
            // Сбрасываем кнопки
            document.getElementById('muteButton').textContent = '🎤';
            document.getElementById('videoToggleButton').textContent = '📹';
        }
        
        async function createPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            // Получаем удаленный поток
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                document.getElementById('remoteVideo').srcObject = remoteStream;
            };
            
            // Собираем ICE кандидаты
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && callData) {
                    iceCandidatesToSend.push(event.candidate.toJSON());
                    
                    // Отправляем кандидаты каждые 500 мс
                    if (!iceCandidateInterval) {
                        iceCandidateInterval = setInterval(async () => {
                            if (iceCandidatesToSend.length > 0 && callData) {
                                try {
                                    await db.collection('calls').doc(callData.id).update({
                                        iceCandidates: firebase.firestore.FieldValue.arrayUnion(...iceCandidatesToSend)
                                    });
                                    iceCandidatesToSend = [];
                                } catch (error) {
                                    console.error('Ошибка отправки ICE кандидатов:', error);
                                }
                            }
                        }, 500);
                    }
                }
            };
            
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'failed' || 
                    peerConnection.connectionState === 'disconnected' ||
                    peerConnection.connectionState === 'closed') {
                    
                    if (callState === 'connected') {
                        showNotification('Соединение потеряно', 'error');
                    }
                    endCall();
                }
            };
            
            peerConnection.oniceconnectionstatechange = () => {
                if (peerConnection.iceConnectionState === 'failed' ||
                    peerConnection.iceConnectionState === 'disconnected') {
                    
                    if (callState === 'connected') {
                        showNotification('Ошибка соединения', 'error');
                    }
                }
            };
        }
        
        function startCallTimer() {
            callStartTime = new Date();
            const callDurationEl = document.getElementById('callDuration');
            
            if (callDurationInterval) {
                clearInterval(callDurationInterval);
            }
            
            callDurationInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - callStartTime) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                
                callDurationEl.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function toggleMute() {
            if (!localStream) return;
            
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            const muteButton = document.getElementById('muteButton');
            muteButton.textContent = isMuted ? '🔇' : '🎤';
            muteButton.classList.toggle('active', isMuted);
            
            showNotification(isMuted ? 'Микрофон отключен' : 'Микрофон включен', 'info');
        }
        
        function toggleVideo() {
            if (!localStream) return;
            
            isVideoOff = !isVideoOff;
            localStream.getVideoTracks().forEach(track => {
                track.enabled = !isVideoOff;
            });
            
            const videoButton = document.getElementById('videoToggleButton');
            videoButton.textContent = isVideoOff ? '📷' : '📹';
            videoButton.classList.toggle('active', isVideoOff);
            
            showNotification(isVideoOff ? 'Видео отключено' : 'Видео включено', 'info');
        }
        
        // Звуковые функции
        function playMessageSound() {
            const sound = document.getElementById('messageSound');
            sound.currentTime = 0;
            sound.play().catch(e => console.log('Ошибка воспроизведения звука:', e));
        }
        
        function playCallSound() {
            const sound = document.getElementById('callSound');
            sound.currentTime = 0;
            sound.play().catch(e => console.log('Ошибка воспроизведения звука звонка:', e));
        }
        
        function stopCallSound() {
            const sound = document.getElementById('callSound');
            sound.pause();
            sound.currentTime = 0;
        }
        
        function playCallEndSound() {
            const sound = document.getElementById('callEndSound');
            sound.currentTime = 0;
            sound.play().catch(e => console.log('Ошибка воспроизведения звука завершения:', e));
        }
        
        // === ФУНКЦИЯ КОПИРОВАНИЯ СООБЩЕНИЯ ===
        
        window.copyMessage = function(messageId) {
            if (!currentChatId || !messageId) return;
            
            const message = messages[currentChatId]?.find(m => m.id === messageId);
            if (!message || message.isDeleted) {
                showNotification('Сообщение не найдено', 'error');
                return;
            }
            
            if (message.type !== 'text') {
                showNotification('Можно копировать только текстовые сообщения', 'error');
                return;
            }
            
            try {
                navigator.clipboard.writeText(message.text).then(() => {
                    showNotification('Сообщение скопировано в буфер обмена', 'success');
                    
                    // Скрываем расширенное меню сообщения
                    if (expandedMessageId === messageId) {
                        const expandedMessage = document.querySelector(`[data-message-id="${expandedMessageId}"]`);
                        if (expandedMessage) {
                            expandedMessage.classList.remove('expanded');
                        }
                        expandedMessageId = null;
                    }
                }).catch(err => {
                    console.error('Ошибка копирования:', err);
                    
                    // Альтернативный способ через textarea
                    const textarea = document.createElement('textarea');
                    textarea.value = message.text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    showNotification('Сообщение скопировано в буфер обмена', 'success');
                    
                    if (expandedMessageId === messageId) {
                        const expandedMessage = document.querySelector(`[data-message-id="${expandedMessageId}"]`);
                        if (expandedMessage) {
                            expandedMessage.classList.remove('expanded');
                        }
                        expandedMessageId = null;
                    }
                });
            } catch (error) {
                console.error('Ошибка копирования:', error);
                showNotification('Ошибка копирования сообщения', 'error');
            }
        };

        // === ФУНКЦИИ ДЛЯ ОТВЕТА НА СООБЩЕНИЯ ===
        
        window.replyToMessage = function(messageId) {
            if (!currentChatId || !messageId) return;
            
            const message = messages[currentChatId]?.find(m => m.id === messageId);
            if (!message || message.isDeleted) return;
            
            replyingToMessageId = messageId;
            replyingToMessage = message;
            
            // Показываем индикатор реплая
            const replyIndicator = document.getElementById('replyIndicator');
            const replyToLabel = document.getElementById('replyToLabel');
            const replyPreviewText = document.getElementById('replyPreviewText');
            
            const sender = users.find(u => u.username === message.sender);
            const senderName = sender ? sender.name : message.sender;
            
            let previewText = '';
            if (message.type === 'text') {
                previewText = message.text;
            } else if (message.type === 'image') {
                previewText = '📷 Фото';
            } else if (message.type === 'voice') {
                previewText = '🎤 Голосовое сообщение';
            } else if (message.type === 'sticker') {
                previewText = '🎨 Стикер';
            }
            
            if (previewText.length > 50) {
                previewText = previewText.substring(0, 50) + '...';
            }
            
            replyToLabel.textContent = `Ответ на сообщение от ${senderName}`;
            replyPreviewText.textContent = previewText;
            replyIndicator.style.display = 'flex';
            
            // Фокусируемся на поле ввода
            const messageInput = document.getElementById('mobileMessageInput');
            messageInput.focus();
            
            // Скрываем расширенное меню сообщения
            if (expandedMessageId) {
                const expandedMessage = document.querySelector(`[data-message-id="${expandedMessageId}"]`);
                if (expandedMessage) {
                    expandedMessage.classList.remove('expanded');
                }
                expandedMessageId = null;
            }
        };
        
        function cancelReply() {
            replyingToMessageId = null;
            replyingToMessage = null;
            document.getElementById('replyIndicator').style.display = 'none';
        }
        
        // === ФУНКЦИИ ДЛЯ РЕДАКТИРОВАНИЯ СООБЩЕНИЙ ===
        
        window.editMessage = function(messageId) {
            if (!currentChatId || !messageId) return;
            
            const message = messages[currentChatId]?.find(m => m.id === messageId);
            if (!message || message.isDeleted) return;
            
            if (message.sender !== currentUser.username) {
                showNotification('Вы можете редактировать только свои сообщения', 'error');
                return;
            }
            
            if (message.type !== 'text') {
                showNotification('Можно редактировать только текстовые сообщения', 'error');
                return;
            }
            
            editingMessageId = messageId;
            editingMessage = message;
            
            showEditMessageModal(message.text);
            
            // Скрываем расширенное меню сообщения
            if (expandedMessageId) {
                const expandedMessage = document.querySelector(`[data-message-id="${expandedMessageId}"]`);
                if (expandedMessage) {
                    expandedMessage.classList.remove('expanded');
                }
                expandedMessageId = null;
            }
        };
        
        function showEditMessageModal(currentText) {
            const modalHTML = `
                <div class="modal-overlay edit-modal">
                    <div class="modal">
                        <div class="modal-icon info">✏️</div>
                        <div class="modal-title">Редактирование сообщения</div>
                        
                        <div class="modal-message">
                            Отредактируйте текст сообщения:
                        </div>
                        
                        <textarea class="edit-message-input" id="editMessageInput" placeholder="Введите новый текст сообщения...">${currentText}</textarea>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="cancelEditBtn">Отмена</button>
                            <button class="btn btn-primary" id="saveEditBtn">Сохранить</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
            
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                editingMessageId = null;
                editingMessage = null;
                document.getElementById('modalContainer').innerHTML = '';
            });
            
            document.getElementById('saveEditBtn').addEventListener('click', async () => {
                const newText = document.getElementById('editMessageInput').value.trim();
                
                if (!newText) {
                    showNotification('Введите текст сообщения', 'error');
                    return;
                }
                
                await saveEditedMessage(newText);
                document.getElementById('modalContainer').innerHTML = '';
            });
            
            // Автофокус на поле ввода
            setTimeout(() => {
                document.getElementById('editMessageInput').focus();
                document.getElementById('editMessageInput').select();
            }, 100);
        }
        
        async function saveEditedMessage(newText) {
            try {
                editingMessage.text = newText;
                editingMessage.edited = true;
                editingMessage.editedAt = new Date().toISOString();
                
                await db.collection('messages').doc(editingMessageId).update({
                    text: newText,
                    edited: true,
                    editedAt: editingMessage.editedAt
                });
                
                // Обновляем UI
                updateMessageUI(editingMessageId);
                
                showNotification('Сообщение отредактировано', 'success');
                
                editingMessageId = null;
                editingMessage = null;
                
            } catch (error) {
                console.error('Ошибка редактирования сообщения:', error);
                showNotification('Ошибка редактирования сообщения', 'error');
            }
        }
        
        // === ФУНКЦИИ ДЛЯ ПЕРЕСЫЛКИ СООБЩЕНИЙ ===
        
        window.forwardMessage = function(messageId) {
            if (!currentChatId || !messageId) return;
            
            const message = messages[currentChatId]?.find(m => m.id === messageId);
            if (!message || message.isDeleted) return;
            
            showForwardMessageModal(message);
            
            // Скрываем расширенное меню сообщения
            if (expandedMessageId) {
                const expandedMessage = document.querySelector(`[data-message-id="${expandedMessageId}"]`);
                if (expandedMessage) {
                    expandedMessage.classList.remove('expanded');
                }
                expandedMessageId = null;
            }
        };
        
        function showForwardMessageModal(message) {
            if (!currentUser) return;
            
            const modalHTML = `
                <div class="modal-overlay forward-modal">
                    <div class="modal">
                        <div class="modal-icon info">↪️</div>
                        <div class="modal-title">Переслать сообщение</div>
                        
                        <div class="modal-message">
                            Выберите чат для пересылки:
                        </div>
                        
                        <div class="forward-contacts-list" id="forwardContactsList">
                            <div class="loading">
                                <div class="spinner"></div>
                                Загрузка контактов...
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="cancelForwardBtn">Отмена</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
            
            loadForwardContacts(message);
            
            document.getElementById('cancelForwardBtn').addEventListener('click', () => {
                document.getElementById('modalContainer').innerHTML = '';
            });
        }
        
        function loadForwardContacts(messageToForward) {
            const contactsList = document.getElementById('forwardContactsList');
            contactsList.innerHTML = '';
            
            if (!currentUser) return;
            
            const userContacts = contacts[currentUser.username] || [];
            const availableChats = userContacts.filter(username => {
                // Исключаем текущий чат
                return username !== currentChat;
            });
            
            if (availableChats.length === 0) {
                contactsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">👤</div>
                        <div class="empty-text">Нет доступных чатов</div>
                        <div class="empty-subtext">Добавьте контакты для пересылки</div>
                    </div>
                `;
                return;
            }
            
            availableChats.forEach(username => {
                const user = users.find(u => u.username === username);
                if (!user) return;
                
                // Не показываем удаленных пользователей
                if (user.isDeleted) return;
                
                const contactItem = document.createElement('div');
                contactItem.className = 'forward-contact-item';
                contactItem.dataset.username = username;
                
                const userPhoto = user.photo || null;
                
                contactItem.innerHTML = `
                    <div class="forward-contact-avatar ${userPhoto ? 'has-photo' : ''}">
                        ${userPhoto ? `<img src="${userPhoto}" alt="${user.name}">` : user.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="forward-contact-info">
                        <div class="forward-contact-name">${user.name}</div>
                        <div class="forward-contact-username">@${user.username}</div>
                    </div>
                `;
                
                contactItem.addEventListener('click', async () => {
                    await forwardMessageToChat(messageToForward, username);
                    document.getElementById('modalContainer').innerHTML = '';
                });
                
                contactsList.appendChild(contactItem);
            });
        }
        
        async function forwardMessageToChat(originalMessage, targetUsername) {
            try {
                const targetUser = users.find(u => u.username === targetUsername);
                if (!targetUser) {
                    showNotification('Пользователь не найден', 'error');
                    return;
                }
                
                // Создаем пересланное сообщение
                const forwardedMessage = {
                    id: Date.now().toString(),
                    sender: currentUser.username,
                    text: originalMessage.text,
                    type: originalMessage.type,
                    data: originalMessage.data,
                    duration: originalMessage.duration,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now(),
                    read: false,
                    readBy: [],
                    isDeleted: false,
                    isForwarded: true,
                    originalSender: originalMessage.sender,
                    forwardedAt: new Date().toISOString()
                };
                
                // Определяем chatId для пересылки
                let targetChatId;
                if (targetUser.isGroup) {
                    targetChatId = targetUsername;
                } else {
                    const usersForChat = [currentUser.username, targetUsername].sort();
                    targetChatId = `private_${usersForChat.join('_')}`;
                }
                
                // Сохраняем сообщение
                await saveMessageToFirebase(forwardedMessage, targetChatId);
                
                showNotification(`Сообщение переслано ${targetUser.name}`, 'success');
                
            } catch (error) {
                console.error('Ошибка пересылки сообщения:', error);
                showNotification('Ошибка пересылки сообщения', 'error');
            }
        }
        
        // === ИСПРАВЛЕННЫЕ ГОЛОСОВЫЕ СООБЩЕНИЯ ===
        
        // Глобальные функции для воспроизведения голосовых сообщений
        window.playVoiceMessage = function(messageId) {
            if (!currentChatId) return;
            
            console.log('Попытка воспроизведения сообщения:', messageId);
            
            // Останавливаем текущее воспроизведение
            if (currentPlayingAudio) {
                stopVoicePlayback();
            }
            
            const message = messages[currentChatId]?.find(msg => msg.id === messageId);
            if (!message || !message.data || message.isDeleted) {
                console.error('Сообщение не найдено, удалено или нет данных:', messageId);
                showNotification('Не удалось воспроизвести голосовое сообщение', 'error');
                return;
            }
            
            console.log('Найдено сообщение:', message);
            
            try {
                currentPlayingAudio = new Audio(message.data);
                currentPlayingMessageId = messageId;
                
                currentPlayingAudio.onloadedmetadata = () => {
                    console.log('Аудио загружено, длительность:', currentPlayingAudio.duration);
                    updateVoiceMessageUI(messageId, true, 0, currentPlayingAudio.duration || message.duration);
                };
                
                currentPlayingAudio.onplay = () => {
                    console.log('Воспроизведение начато');
                    updateVoiceMessageUI(messageId, true, 0, currentPlayingAudio.duration || message.duration);
                    
                    const progressInterval = setInterval(() => {
                        if (currentPlayingAudio && !currentPlayingAudio.paused) {
                            const currentTime = currentPlayingAudio.currentTime;
                            const duration = currentPlayingAudio.duration || message.duration;
                            updateVoiceMessageUI(messageId, true, currentTime, duration);
                        } else {
                            clearInterval(progressInterval);
                        }
                    }, 100);
                    
                    currentPlayingAudio.onended = () => {
                        clearInterval(progressInterval);
                        console.log('Воспроизведение завершено');
                        stopVoicePlayback();
                        if (currentPlayingMessageId === messageId) {
                            updateVoiceMessageUI(messageId, false, 0, message.duration);
                        }
                    };
                };
                
                currentPlayingAudio.onerror = (e) => {
                    console.error('Ошибка воспроизведения голосового сообщения:', e);
                    stopVoicePlayback();
                    showNotification('Ошибка воспроизведения аудио', 'error');
                };
                
                const playPromise = currentPlayingAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error('Ошибка при попытке воспроизведения:', error);
                        showNotification('Ошибка воспроизведения', 'error');
                        stopVoicePlayback();
                    });
                }
                
            } catch (error) {
                console.error('Ошибка воспроизведения:', error);
                showNotification('Ошибка воспроизведения', 'error');
                stopVoicePlayback();
            }
        };
        
        window.toggleVoicePlayback = function(messageId) {
            console.log('toggleVoicePlayback для сообщения:', messageId);
            
            if (currentPlayingMessageId === messageId && currentPlayingAudio) {
                if (currentPlayingAudio.paused) {
                    console.log('Возобновление воспроизведения');
                    currentPlayingAudio.play();
                } else {
                    console.log('Пауза воспроизведения');
                    currentPlayingAudio.pause();
                    updateVoiceMessageUI(messageId, false, currentPlayingAudio.currentTime, 
                                       currentPlayingAudio.duration);
                }
            } else {
                console.log('Начало воспроизведения нового сообщения');
                window.playVoiceMessage(messageId);
            }
        };
        
        function stopVoicePlayback() {
            console.log('Остановка воспроизведения');
            
            if (currentPlayingAudio) {
                currentPlayingAudio.pause();
                currentPlayingAudio = null;
            }
            
            if (currentPlayingMessageId) {
                const message = messages[currentChatId]?.find(msg => msg.id === currentPlayingMessageId);
                if (message) {
                    updateVoiceMessageUI(currentPlayingMessageId, false, 0, message.duration);
                }
                currentPlayingMessageId = null;
            }
        }
        
        function updateVoiceMessageUI(messageId, isPlaying, currentTime, duration) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) {
                console.log('Элемент сообщения не найден:', messageId);
                return;
            }
            
            const playButton = messageElement.querySelector('.voice-play-button');
            const playIcon = messageElement.querySelector('.voice-play-icon');
            const currentTimeElement = messageElement.querySelector('.current-time');
            const progressElement = messageElement.querySelector('.wave-progress');
            const totalTimeElement = messageElement.querySelector('.voice-duration span:last-child');
            
            if (playButton && playIcon) {
                if (isPlaying && currentPlayingAudio && !currentPlayingAudio.paused) {
                    playButton.classList.add('playing');
                    playIcon.textContent = '❚❚';
                    playIcon.classList.add('pause');
                } else {
                    playButton.classList.remove('playing');
                    playIcon.textContent = '▶';
                    playIcon.classList.remove('pause');
                }
            }
            
            if (currentTimeElement) {
                const formattedTime = formatVoiceTime(currentTime);
                currentTimeElement.textContent = formattedTime;
            }
            
            if (totalTimeElement && duration > 0) {
                const formattedDuration = formatVoiceTime(duration);
                totalTimeElement.textContent = formattedDuration;
            }
            
            if (progressElement && duration > 0) {
                const progressPercent = (currentTime / duration) * 100;
                progressElement.style.width = `${Math.min(100, progressPercent)}%`;
            }
        }
        
        function formatVoiceTime(seconds) {
            const secs = Math.floor(seconds);
            const mins = Math.floor(secs / 60);
            const remainingSecs = secs % 60;
            return `${mins.toString().padStart(2, '0')}:${remainingSecs.toString().padStart(2, '0')}`;
        }
        
        async function handleVoiceMessage() {
            console.log("Запуск записи голосового сообщения...");
            
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showInfoModal(
                        'Не поддерживается',
                        'Ваш браузер не поддерживает запись голосовых сообщений.',
                        'warning'
                    );
                    return;
                }
                
                stopVoicePlayback();
                
                console.log("Запрос доступа к микрофону...");
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
                    ? 'audio/webm;codecs=opus' 
                    : 'audio/webm';
                
                mediaRecorder = new MediaRecorder(audioStream, { mimeType });
                audioChunks = [];
                
                showVoiceRecordingInterface();
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    console.log("Запись завершена, обработка данных...");
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64data = reader.result;
                        await sendVoiceMessage(base64data, currentRecordingDuration);
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                        audioStream = null;
                    }
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error("Ошибка записи:", event.error);
                    showNotification('Ошибка записи голосового сообщения', 'error');
                    hideVoiceRecordingInterface();
                    
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                        audioStream = null;
                    }
                };
                
                console.log("Начало записи...");
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                currentRecordingDuration = 0;
                
                updateRecordingTimer();
                
            } catch (error) {
                console.error("Ошибка при запуске записи:", error);
                
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                    audioStream = null;
                }
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    showInfoModal(
                        'Доступ к микрофону запрещен',
                        'Пожалуйста, разрешите доступ к микрофону в настройках браузера.',
                        'warning'
                    );
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    showInfoModal(
                        'Микрофон не найден',
                        'Не удалось найти микрофон.',
                        'warning'
                    );
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    showInfoModal(
                        'Микрофон занят',
                        'Микрофон используется другим приложением.',
                        'warning'
                    );
                } else {
                    showInfoModal(
                        'Ошибка микрофона',
                        'Произошла неизвестная ошибка при доступе к микрофону.',
                        'error'
                    );
                }
            }
        }

        function stopRecording() {
            console.log("Остановка записи...");
            
            if (mediaRecorder && isRecording) {
                try {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    if (recordingTimer) {
                        clearInterval(recordingTimer);
                        recordingTimer = null;
                    }
                } catch (error) {
                    console.error("Ошибка при остановке записи:", error);
                }
            }
            
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
        }

        function cancelRecording() {
            console.log("Отмена записи...");
            
            if (mediaRecorder && isRecording) {
                try {
                    mediaRecorder.stop();
                } catch (error) {
                    console.error("Ошибка при отмене записи:", error);
                }
            }
            
            isRecording = false;
            
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            
            hideVoiceRecordingInterface();
            showNotification('Запись отменена', 'info');
        }

        async function sendVoiceMessage(audioData, duration) {
            console.log("Отправка голосового сообщения...");
            
            if (!currentChat || !audioData) {
                showNotification('Ошибка: нет данных для отправки', 'error');
                return;
            }
            
            const contact = users.find(u => u.username === currentChat);
            if (!contact) return;
            
            const chatId = getChatId(contact);
            const messageId = Date.now().toString();
            
            const message = {
                id: messageId,
                sender: currentUser.username,
                type: 'voice',
                data: audioData,
                duration: Math.round(duration),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                timestamp: Date.now(),
                read: false,
                readBy: [],
                isDeleted: false,
                deletedForEveryone: false
            };
            
            // Добавляем информацию о реплае, если есть
            if (replyingToMessageId) {
                message.replyTo = replyingToMessageId;
                message.replyToMessage = {
                    id: replyingToMessage.id,
                    sender: replyingToMessage.sender,
                    text: replyingToMessage.text,
                    type: replyingToMessage.type
                };
            }
            
            try {
                await saveMessageToFirebase(message, chatId);
                showNotification('Голосовое сообщение отправлено!', 'success');
                
                // Сбрасываем реплай
                if (replyingToMessageId) {
                    cancelReply();
                }
                
            } catch (error) {
                console.error('Ошибка отправки голосового сообщения:', error);
                showNotification('Ошибка отправки голосового сообщения', 'error');
            } finally {
                hideVoiceRecordingInterface();
            }
        }

        function showVoiceRecordingInterface() {
            const recordingHTML = `
                <div class="voice-recording-overlay">
                    <div class="voice-recording-container">
                        <div class="recording-icon">🎤</div>
                        <div class="recording-title">Идет запись...</div>
                        <div class="recording-timer" id="recordingTimer">00:00</div>
                        <div class="recording-wave">
                            <div class="recording-wave-bar"></div>
                            <div class="recording-wave-bar"></div>
                            <div class="recording-wave-bar"></div>
                            <div class="recording-wave-bar"></div>
                            <div class="recording-wave-bar"></div>
                            <div class="recording-wave-bar"></div>
                            <div class="recording-wave-bar"></div>
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin: 20px 0;">
                            Нажмите "Отправить" чтобы отправить голосовое сообщение
                        </div>
                        <div class="recording-actions">
                            <button class="btn btn-secondary cancel-recording" id="cancelRecordingBtn">
                                Отмена
                            </button>
                            <button class="btn btn-primary send-recording" id="sendRecordingBtn">
                                Отправить
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = recordingHTML;
            
            document.getElementById('cancelRecordingBtn').addEventListener('click', cancelRecording);
            document.getElementById('sendRecordingBtn').addEventListener('click', () => {
                stopRecording();
            });
            
            document.querySelector('.voice-recording-overlay').addEventListener('click', (e) => {
                if (e.target.classList.contains('voice-recording-overlay')) {
                    cancelRecording();
                }
            });
            
            document.addEventListener('keydown', function closeOnEsc(e) {
                if (e.key === 'Escape') {
                    cancelRecording();
                    document.removeEventListener('keydown', closeOnEsc);
                }
            });
        }

        function hideVoiceRecordingInterface() {
            const modal = document.getElementById('modalContainer');
            if (modal && modal.querySelector('.voice-recording-overlay')) {
                modal.innerHTML = '';
            }
        }

        function updateRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
            }
            
            recordingTimer = setInterval(() => {
                if (isRecording) {
                    const currentTime = Date.now();
                    currentRecordingDuration = Math.floor((currentTime - recordingStartTime) / 1000);
                    
                    const timerElement = document.getElementById('recordingTimer');
                    if (timerElement) {
                        const minutes = Math.floor(currentRecordingDuration / 60);
                        const seconds = currentRecordingDuration % 60;
                        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        if (currentRecordingDuration >= 300) {
                            stopRecording();
                        }
                    }
                }
            }, 1000);
        }

        function createWaveformBars(duration) {
            const barCount = Math.min(40, Math.max(10, Math.floor(duration * 2)));
            let barsHTML = '';
            
            for (let i = 0; i < barCount; i++) {
                const height = 20 + Math.random() * 40;
                barsHTML += `<div class="wave-bar" style="height: ${height}%"></div>`;
            }
            
            return barsHTML;
        }

        // === ФУНКЦИИ ДЛЯ РАСШИРЕНИЯ И УДАЛЕНИЯ СООБЩЕНИЙ ===
        
        let expandedMessageId = null;
        
        window.toggleMessageExpansion = function(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            if (expandedMessageId && expandedMessageId !== messageId) {
                const prevMessage = document.querySelector(`[data-message-id="${expandedMessageId}"]`);
                if (prevMessage) {
                    prevMessage.classList.remove('expanded');
                }
            }
            
            messageElement.classList.toggle('expanded');
            
            if (messageElement.classList.contains('expanded')) {
                expandedMessageId = messageId;
                
                setTimeout(() => {
                    messageElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else {
                expandedMessageId = null;
            }
        };
        
        window.deleteMessageForEveryone = function(messageId) {
            if (!currentChatId || !messageId) return;
            
            const messageIndex = messages[currentChatId]?.findIndex(m => m.id === messageId);
            if (messageIndex === -1 || messageIndex === undefined) {
                showNotification('Сообщение не найдено', 'error');
                return;
            }
            
            const message = messages[currentChatId][messageIndex];
            
            if (message.sender !== currentUser.username) {
                showNotification('Вы можете удалять только свои сообщения', 'error');
                return;
            }
            
            showConfirmModal(
                'Удалить сообщение для всех?',
                'Это действие удалит сообщение у всех участников чата. Восстановить его будет невозможно.',
                'danger',
                async () => {
                    try {
                        message.isDeleted = true;
                        message.deletedAt = new Date().toISOString();
                        message.deletedForEveryone = true;
                        
                        await db.collection('messages').doc(messageId).update({
                            isDeleted: true,
                            deletedAt: message.deletedAt,
                            deletedForEveryone: true
                        });
                        
                        // Устанавливаем таймер для удаления уведомления через 3 минуты
                        if (deletedMessageTimers[messageId]) {
                            clearTimeout(deletedMessageTimers[messageId]);
                        }
                        
                        deletedMessageTimers[messageId] = setTimeout(() => {
                            // Полностью удаляем сообщение из UI через 3 минуты
                            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                            if (messageElement) {
                                messageElement.remove();
                                // Удаляем из массива сообщений
                                const msgIndex = messages[currentChatId].findIndex(m => m.id === messageId);
                                if (msgIndex !== -1) {
                                    messages[currentChatId].splice(msgIndex, 1);
                                }
                            }
                            delete deletedMessageTimers[messageId];
                        }, 3 * 60 * 1000); // 3 минуты
                        
                        updateMessageUI(messageId);
                        
                        if (expandedMessageId === messageId) {
                            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                            if (messageElement) {
                                messageElement.classList.remove('expanded');
                                expandedMessageId = null;
                            }
                        }
                        
                        showNotification('Сообщение удалено для всех участников', 'success');
                        
                    } catch (error) {
                        console.error('Ошибка удаления сообщения:', error);
                        showNotification('Ошибка удаления сообщения', 'error');
                    }
                }
            );
        };
        
        function updateMessageUI(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            const message = messages[currentChatId]?.find(m => m.id === messageId);
            if (!message) return;
            
            const isOutgoing = message.sender === currentUser.username;
            const showSender = !isOutgoing;
            
            messageElement.remove();
            addMobileMessage(message, showSender);
            
            if (expandedMessageId === messageId) {
                expandedMessageId = null;
            }
        }

        // === ФУНКЦИИ УГОЛКА УЧЕНИКА ===
        
        function showStudentCorner() {
            const studentCornerHTML = `
                <div class="student-corner-overlay">
                    <div class="student-corner-container">
                        <div class="student-corner-header">
                            <h2>Уголок ученика</h2>
                            <p>Привет, ${currentUser ? currentUser.name : 'Ученик'}! 📚</p>
                        </div>
                        
                        <div class="student-corner-content">
                            <div class="schedule-section">
                                <h3>Расписание уроков (5Б класс)</h3>
                                <div class="schedule-grid" id="scheduleGrid">
                                    <!-- Расписание будет вставлено здесь -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="student-corner-actions">
                            <button class="btn btn-secondary" id="closeStudentCornerBtn">
                                Закрыть
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('studentCornerModal').innerHTML = studentCornerHTML;
            document.getElementById('studentCornerModal').style.display = 'block';
            
            renderScheduleWithHomework();
            
            document.getElementById('closeStudentCornerBtn').addEventListener('click', () => {
                document.getElementById('studentCornerModal').style.display = 'none';
                document.getElementById('studentCornerModal').innerHTML = '';
            });
            
            document.querySelector('.student-corner-overlay').addEventListener('click', (e) => {
                if (e.target.classList.contains('student-corner-overlay')) {
                    document.getElementById('studentCornerModal').style.display = 'none';
                    document.getElementById('studentCornerModal').innerHTML = '';
                }
            });
        }
        
        function renderScheduleWithHomework() {
            const scheduleGrid = document.getElementById('scheduleGrid');
            scheduleGrid.innerHTML = '';
            
            for (const day in schedule) {
                const dayName = daysOfWeek[day];
                const lessons = schedule[day];
                
                const daySchedule = document.createElement('div');
                daySchedule.className = 'day-schedule';
                
                let lessonsHTML = '';
                lessons.forEach((lesson, index) => {
                    const lessonKey = `${day}_${index}`;
                    const homework = homeworkData[lessonKey] || {};
                    const hasHomework = homework.text && homework.text.trim() !== '';
                    const isCompleted = homework.completed || false;
                    
                    let lessonClass = 'lesson-item';
                    if (hasHomework) lessonClass += ' with-homework';
                    if (isCompleted) lessonClass += ' completed';
                    
                    lessonsHTML += `
                        <div class="${lessonClass}" data-lesson-key="${lessonKey}" data-lesson-name="${lesson}" data-day="${day}">
                            <div class="lesson-number">${index + 1}</div>
                            <div class="lesson-name">${lesson}</div>
                            ${hasHomework ? '<div class="homework-indicator">📝</div>' : ''}
                            ${isCompleted ? '<div class="completed-indicator">✓</div>' : ''}
                        </div>
                    `;
                });
                
                daySchedule.innerHTML = `
                    <div class="day-header">${dayName}</div>
                    <div class="lessons-list">
                        ${lessonsHTML}
                    </div>
                `;
                
                scheduleGrid.appendChild(daySchedule);
            }
            
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.addEventListener('click', function() {
                    const lessonKey = this.dataset.lessonKey;
                    const lessonName = this.dataset.lessonName;
                    const day = this.dataset.day;
                    showHomeworkModal(lessonKey, lessonName, day);
                });
            });
        }
        
        function showHomeworkModal(lessonKey, lessonName, day) {
            const dayName = daysOfWeek[day];
            const homework = homeworkData[lessonKey] || {};
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal">
                        <div class="modal-title">Домашнее задание</div>
                        <div class="modal-message">
                            <strong>${dayName}: ${lessonName}</strong>
                        </div>
                        
                        <div class="form-group">
                            <label for="homeworkText">Домашнее задание:</label>
                            <textarea 
                                id="homeworkText" 
                                class="deepseek-input"
                                placeholder="Запишите домашнее задание здесь..."
                                rows="4">${homework.text || ''}</textarea>
                        </div>
                        
                        <div class="setting-item" style="margin: 20px 0;">
                            <div class="setting-info">
                                <div class="setting-title">Выполнено</div>
                                <div class="setting-description">Отметьте, если задание выполнено</div>
                            </div>
                            <div class="theme-toggle" id="homeworkCompletedToggle" style="${homework.completed ? 'transform: scaleX(-1);' : ''}"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="cancelHomeworkBtn">
                                Отмена
                            </button>
                            <button class="btn btn-danger" id="deleteHomeworkBtn" ${!homework.text ? 'style="display: none;"' : ''}>
                                Удалить
                            </button>
                            <button class="btn btn-primary" id="saveHomeworkBtn">
                                Сохранить
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
            
            const toggle = document.getElementById('homeworkCompletedToggle');
            toggle.addEventListener('click', function() {
                this.style.transform = this.style.transform === 'scaleX(-1)' ? '' : 'scaleX(-1)';
            });
            
            if (homework.completed) {
                toggle.style.transform = 'scaleX(-1)';
            }
            
            document.getElementById('cancelHomeworkBtn').addEventListener('click', () => {
                document.getElementById('modalContainer').innerHTML = '';
            });
            
            document.getElementById('deleteHomeworkBtn').addEventListener('click', () => {
                if (confirm('Удалить домашнее задание?')) {
                    delete homeworkData[lessonKey];
                    localStorage.setItem('5bHouseHomework', JSON.stringify(homeworkData));
                    document.getElementById('modalContainer').innerHTML = '';
                    setTimeout(() => {
                        showStudentCorner();
                        showNotification('Домашнее задание удалено', 'success');
                    }, 100);
                }
            });
            
            document.getElementById('saveHomeworkBtn').addEventListener('click', () => {
                const homeworkText = document.getElementById('homeworkText').value.trim();
                const isCompleted = document.getElementById('homeworkCompletedToggle').style.transform === 'scaleX(-1)';
                
                homeworkData[lessonKey] = {
                    text: homeworkText,
                    completed: isCompleted,
                    subject: lessonName,
                    day: dayName,
                    updatedAt: new Date().toISOString()
                };
                
                localStorage.setItem('5bHouseHomework', JSON.stringify(homeworkData));
                document.getElementById('modalContainer').innerHTML = '';
                setTimeout(() => {
                    showStudentCorner();
                    showNotification('Домашнее задание сохранено', 'success');
                }, 100);
            });
        }

        // === ФУНКЦИИ УПРАВЛЕНИЯ ТЕМОЙ ===
        
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            if (isDarkTheme) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('5bHouseDarkTheme', 'true');
                showNotification('Темная тема включена', 'success');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('5bHouseDarkTheme', 'false');
                showNotification('Светлая тема включена', 'success');
            }
        }

        function applyThemeOnLoad() {
            if (isDarkTheme) {
                document.body.classList.add('dark-theme');
            }
        }

        // === ФУНКЦИИ УПРАВЛЕНИЯ ФОТО ПРОФИЛЯ ===
        
        function updateUserPhoto() {
            const avatar = document.getElementById('mobileAvatar');
            const previewImg = document.getElementById('photoPreviewImg');
            const previewContainer = document.getElementById('photoPreview');
            
            if (userPhoto) {
                avatar.innerHTML = `<img src="${userPhoto}" alt="Фото профиля">`;
                avatar.classList.add('has-photo');
                previewImg.src = userPhoto;
                previewContainer.style.display = 'block';
            } else {
                avatar.innerHTML = currentUser ? currentUser.name.charAt(0).toUpperCase() : 'U';
                avatar.classList.remove('has-photo');
                previewImg.src = '';
                previewContainer.style.display = 'none';
            }
        }

        function uploadPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userPhoto = e.target.result;
                        localStorage.setItem('5bHouseUserPhoto', userPhoto);
                        updateUserPhoto();
                        showNotification('Фото профиля обновлено', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function removePhoto() {
            if (confirm('Удалить фото профиля?')) {
                userPhoto = null;
                localStorage.removeItem('5bHouseUserPhoto');
                updateUserPhoto();
                showNotification('Фото профиля удалено', 'success');
            }
        }

        // === ФУНКЦИИ ПОЛНОЭКРАННОГО ПРОСМОТРА ФОТО ===
        
        window.openMobileMedia = function(photoUrl) {
            const overlay = document.createElement('div');
            overlay.className = 'fullscreen-photo-overlay';
            overlay.innerHTML = `
                <div class="fullscreen-photo-container">
                    <img src="${photoUrl}" class="fullscreen-photo" id="fullscreenPhoto">
                    <button class="fullscreen-photo-close" id="fullscreenPhotoClose">×</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            document.getElementById('fullscreenPhotoClose').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
            
            document.addEventListener('keydown', function closeOnEsc(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(overlay);
                    document.removeEventListener('keydown', closeOnEsc);
                }
            });
        };

        // === КРАСИВЫЕ МОДАЛЬНЫЕ ОКНА ===
        
        function showConfirmModal(title, message, icon, onConfirm) {
            const modalHTML = `
                <div class="modal-overlay confirm-modal">
                    <div class="modal">
                        <div class="modal-icon ${icon}">${getIconForType(icon)}</div>
                        <div class="modal-title">${title}</div>
                        <div class="modal-message">${message}</div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="cancelConfirmBtn">Отмена</button>
                            <button class="btn btn-danger" id="confirmActionBtn">Подтвердить</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
            
            document.getElementById('cancelConfirmBtn').addEventListener('click', () => {
                document.getElementById('modalContainer').innerHTML = '';
            });
            
            document.getElementById('confirmActionBtn').addEventListener('click', () => {
                onConfirm();
                document.getElementById('modalContainer').innerHTML = '';
            });
        }
        
        function showInfoModal(title, message, icon) {
            const modalHTML = `
                <div class="modal-overlay confirm-modal">
                    <div class="modal">
                        <div class="modal-icon ${icon}">${getIconForType(icon)}</div>
                        <div class="modal-title">${title}</div>
                        <div class="modal-message">${message}</div>
                        <div class="modal-actions">
                            <button class="btn btn-primary" id="closeInfoBtn">Закрыть</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
            
            document.getElementById('closeInfoBtn').addEventListener('click', () => {
                document.getElementById('modalContainer').innerHTML = '';
            });
        }
        
        function getIconForType(type) {
            switch(type) {
                case 'warning': return '⚠️';
                case 'danger': return '🗑️';
                case 'info': return 'ℹ️';
                case 'success': return '✅';
                default: return 'ℹ️';
            }
        }

        // === ФУНКЦИЯ ОЧИСТКИ ЧАТА ===
        
        function showClearChatConfirm() {
            if (!currentChat) return;
            
            const contact = users.find(u => u.username === currentChat);
            const chatName = contact ? contact.name : 'чата';
            
            showConfirmModal(
                'Очистить историю чата',
                `Вы уверены, что хотите очистить историю переписки с ${chatName}? Это действие нельзя отменить.`,
                'warning',
                async () => {
                    try {
                        if (currentChatId && messages[currentChatId]) {
                            messages[currentChatId] = [];
                            loadMobileMessages();
                            showNotification('История чата очищена', 'success');
                        }
                    } catch (error) {
                        console.error('Ошибка очистки чата:', error);
                        showNotification('Ошибка очистки чата', 'error');
                    }
                }
            );
        }

        // === ФУНКЦИЯ ВЫХОДА ИЗ АККАУНТА ===
        
        function showLogoutConfirm() {
            showConfirmModal(
                'Выход из аккаунта',
                'Вы уверены, что хотите выйти из аккаунта?',
                'info',
                handleLogout
            );
        }

        // === ФУНКЦИЯ УДАЛЕНИЯ АККАУНТА ===
        
        function showDeleteAccountConfirm() {
            showConfirmModal(
                'Удаление аккаунта',
                'ВНИМАНИЕ! Это действие удалит ваш аккаунт и все связанные с ним данные без возможности восстановления. Для восстановления потребуется обратиться к администратору. Вы уверены, что хотите продолжить?',
                'danger',
                async () => {
                    try {
                        if (!currentUser) return;
                        
                        currentUser.isDeleted = true;
                        currentUser.deletedAt = new Date().toISOString();
                        
                        await saveUserToFirebase(currentUser);
                        
                        const userToDelete = {
                            username: currentUser.username,
                            name: currentUser.name,
                            deletedAt: currentUser.deletedAt,
                            secretWord: currentUser.secretWord
                        };
                        
                        deletedUsers = deletedUsers.filter(u => u.username !== currentUser.username);
                        deletedUsers.push(userToDelete);
                        localStorage.setItem('5bHouseDeletedUsers', JSON.stringify(deletedUsers));
                        
                        showInfoModal(
                            'Аккаунт удален',
                            'Ваш аккаунт был успешно удален. Для восстановления обратитесь к администратору.',
                            'success'
                        );
                        
                        setTimeout(() => {
                            handleLogout();
                        }, 3000);
                        
                    } catch (error) {
                        console.error('Ошибка удаления аккаунта:', error);
                        showNotification('Ошибка удаления аккаунта', 'error');
                    }
                }
            );
        }

        // === ФУНКЦИЯ ВОССТАНОВЛЕНИЯ УДАЛЕННОГО АККАУНТА ===
        
        function showRecoverDeletedAccountModal() {
            const modalHTML = `
                <div class="modal-overlay recover-modal">
                    <div class="modal">
                        <div class="modal-icon warning">⚠️</div>
                        <div class="modal-title">Восстановление удаленного аккаунта</div>
                        
                        <div class="warning-box" style="margin-bottom: 20px;">
                            ⚠️ Для восстановления аккаунта необходимо знать кодовое слово
                        </div>
                        
                        <div class="form-group">
                            <label for="recoverDeletedUsernameModal">Никнейм удаленного аккаунта</label>
                            <input type="text" 
                                   id="recoverDeletedUsernameModal" 
                                   placeholder="Введите никнейм удаленного аккаунта"
                                   required>
                        </div>
                        
                        <div class="form-group">
                            <label for="recoverDeletedSecretWordModal">Кодовое слово</label>
                            <input type="password" 
                                   id="recoverDeletedSecretWordModal" 
                                   placeholder="Введите кодовое слово удаленного аккаунта"
                                   required>
                            <small>Кодовое слово, установленное при регистрации</small>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="cancelRecoverDeletedBtn">Отмена</button>
                            <button class="btn btn-warning" id="confirmRecoverDeletedBtn">Восстановить</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
            
            document.getElementById('cancelRecoverDeletedBtn').addEventListener('click', () => {
                document.getElementById('modalContainer').innerHTML = '';
            });
            
            document.getElementById('confirmRecoverDeletedBtn').addEventListener('click', async () => {
                const username = document.getElementById('recoverDeletedUsernameModal').value.trim();
                const secretWord = document.getElementById('recoverDeletedSecretWordModal').value.trim();
                
                if (!username || !secretWord) {
                    showNotification('Заполните все поля', 'error');
                    return;
                }
                
                try {
                    const deletedUser = deletedUsers.find(u => u.username === username);
                    
                    if (!deletedUser) {
                        showNotification('Удаленный аккаунт с таким никнеймом не найден', 'error');
                        return;
                    }
                    
                    if (deletedUser.secretWord !== secretWord) {
                        showNotification('Неверное кодовое слово', 'error');
                        return;
                    }
                    
                    await loadUsersFromFirebase();
                    
                    if (users.find(u => u.username === username && !u.isDeleted)) {
                        showNotification('Пользователь с таким именем уже существует', 'error');
                        return;
                    }
                    
                    const restoredUser = {
                        username: deletedUser.username,
                        name: deletedUser.name,
                        password: 'recovered_' + Date.now(),
                        secretWord: deletedUser.secretWord,
                        isGroup: false,
                        isBlocked: false,
                        blockUntil: null,
                        isDeleted: false,
                        restoredAt: new Date().toISOString()
                    };
                    
                    await saveUserToFirebase(restoredUser);
                    users.push(restoredUser);
                    
                    deletedUsers = deletedUsers.filter(u => u.username !== username);
                    localStorage.setItem('5bHouseDeletedUsers', JSON.stringify(deletedUsers));
                    
                    document.getElementById('modalContainer').innerHTML = '';
                    
                    showInfoModal(
                        'Аккаунт восстановлен',
                        'Аккаунт успешно восстановлен! Используйте функцию восстановления пароля для установки нового пароля.',
                        'success'
                    );
                    
                } catch (error) {
                    console.error('Ошибка восстановления:', error);
                    showNotification('Ошибка при восстановлении аккаунта', 'error');
                }
            });
        }

        // === ФУНКЦИЯ СМЕНЫ КОДОВОГО СЛОВА ===
        
        function showChangeSecretWordModal() {
            if (!currentUser) return;
            
            const modalHTML = `
                <div class="modal-overlay recover-modal">
                    <div class="modal">
                        <div class="modal-icon info">🔒</div>
                        <div class="modal-title">Изменение кодового слова</div>
                        
                        <div class="info-box" style="margin-bottom: 20px;">
                            ℹ️ Кодовое слово используется для восстановления пароля
                        </div>
                        
                        <div class="form-group">
                            <label for="currentSecretWordModal">Текущее кодовое слово</label>
                            <input type="password" 
                                   id="currentSecretWordModal" 
                                   placeholder="Введите текущее кодовое слово"
                                   required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newSecretWordModal">Новое кодовое слово</label>
                            <input type="password" 
                                   id="newSecretWordModal" 
                                   placeholder="Введите новое кодовое слово"
                                   required>
                            <small>Минимум 4 символа</small>
                        </div>
                        
        <div class="form-group">
                            <label for="confirmSecretWordModal">Подтверждение нового кодового слова</label>
                            <input type="password" 
                                   id="confirmSecretWordModal" 
                                   placeholder="Повторите новое кодовое слово"
                                   required>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="cancelChangeSecretBtn">Отмена</button>
                            <button class="btn btn-primary" id="confirmChangeSecretBtn">Изменить</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
            
            document.getElementById('cancelChangeSecretBtn').addEventListener('click', () => {
                document.getElementById('modalContainer').innerHTML = '';
            });
            
            document.getElementById('confirmChangeSecretBtn').addEventListener('click', async () => {
                const currentSecret = document.getElementById('currentSecretWordModal').value.trim();
                const newSecret = document.getElementById('newSecretWordModal').value.trim();
                const confirmSecret = document.getElementById('confirmSecretWordModal').value.trim();
                
                if (!currentSecret || !newSecret || !confirmSecret) {
                    showNotification('Заполните все поля', 'error');
                    return;
                }
                
                if (newSecret.length < 4) {
                    showNotification('Кодовое слово должно быть не менее 4 символов', 'error');
                    return;
                }
                
                if (newSecret !== confirmSecret) {
                    showNotification('Новые кодовые слова не совпадают', 'error');
                    return;
                }
                
                if (currentUser.secretWord !== currentSecret) {
                    showNotification('Текущее кодовое слово неверно', 'error');
                    return;
                }
                
                try {
                    currentUser.secretWord = newSecret;
                    await saveUserToFirebase(currentUser);
                    
                    localStorage.setItem('5bHouseCurrentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('modalContainer').innerHTML = '';
                    
                    showNotification('Кодовое слово успешно изменено!', 'success');
                    
                } catch (error) {
                    console.error('Ошибка изменения кодового слова:', error);
                    showNotification('Ошибка изменения кодового слова', 'error');
                }
            });
        }

        // === АДМИН ПАНЕЛЬ - ИСПРАВЛЕННАЯ (без бана/разбана) ===
        
        function showAdminPanel() {
            const adminPassword = prompt('Введите пароль администратора:');
            
            if (adminPassword === '11122344') {
                loadAdminPanel();
            } else if (adminPassword !== null) {
                showNotification('Неверный пароль', 'error');
            }
        }
        
        function loadAdminPanel() {
            const adminHTML = `
                <div class="admin-panel">
                    <div class="admin-header">
                        <h2 style="margin: 0;">Админ панель</h2>
                        <button class="btn btn-secondary" id="closeAdminPanelBtn">Закрыть</button>
                    </div>
                    
                    <div class="admin-tabs">
                        <button class="admin-tab active" data-tab="users">👥 Пользователи</button>
                        <button class="admin-tab" data-tab="group-messages">💬 Сообщения группы</button>
                    </div>
                    
                    <div id="adminUsersSection" class="admin-section">
                        <h3>Управление пользователями</h3>
                        <div class="user-list" id="adminUsersList">
                            <div class="loading">
                                <div class="spinner"></div>
                                Загрузка пользователей...
                            </div>
                        </div>
                    </div>
                    
                    <div id="adminMessagesSection" class="admin-section" style="display: none;">
                        <h3>Сообщения в группе "5Б Хаус"</h3>
                        <div class="message-list" id="adminGroupMessages">
                            <div class="loading">
                                <div class="spinner"></div>
                                Загрузка сообщений...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = adminHTML;
            
            loadAdminUsers();
            
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabId = this.dataset.tab;
                    document.getElementById('adminUsersSection').style.display = 
                        tabId === 'users' ? 'block' : 'none';
                    document.getElementById('adminMessagesSection').style.display = 
                        tabId === 'group-messages' ? 'block' : 'none';
                    
                    if (tabId === 'group-messages') {
                        loadAdminGroupMessages();
                    }
                });
            });
            
            document.getElementById('closeAdminPanelBtn').addEventListener('click', () => {
                document.getElementById('modalContainer').innerHTML = '';
            });
        }
        
        async function loadAdminUsers() {
            try {
                await loadUsersFromFirebase();
                const usersList = document.getElementById('adminUsersList');
                
                if (users.length === 0) {
                    usersList.innerHTML = '<div class="empty-state">Нет пользователей</div>';
                    return;
                }
                
                usersList.innerHTML = '';
                
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    let statusClass = 'status-active';
                    let statusText = 'Активен';
                    
                    if (user.isGroup) {
                        statusClass = 'status-group';
                        statusText = 'Группа';
                    } else if (user.isDeleted) {
                        statusClass = 'status-deleted';
                        statusText = 'Удален';
                    }
                    
                    const userPhoto = user.photo || null;
                    
                    userItem.innerHTML = `
                        <div class="user-item-info">
                            <div class="user-item-avatar ${userPhoto ? 'has-photo' : ''}">
                                ${userPhoto ? `<img src="${userPhoto}" alt="${user.name}">` : user.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="user-item-details">
                                <h4>${user.name} <span style="font-size: 12px; color: var(--text-light);">@${user.username}</span></h4>
                                <p>
                                    <span class="user-status-badge ${statusClass}">${statusText}</span>
                                </p>
                            </div>
                        </div>
                        <div class="user-actions">
                            ${!user.isGroup && !user.isDeleted ? `
                                <button class="admin-btn delete" data-username="${user.username}" onclick="deleteUserAsAdmin('${user.username}')">
                                    Удалить
                                </button>
                            ` : ''}
                            
                            ${user.isDeleted ? `
                                <button class="admin-btn restore" data-username="${user.username}" onclick="restoreUserAsAdmin('${user.username}')">
                                    Восстановить
                                </button>
                            ` : ''}
                        </div>
                    `;
                    
                    usersList.appendChild(userItem);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                document.getElementById('adminUsersList').innerHTML = 
                    '<div class="empty-state">Ошибка загрузки пользователей</div>';
            }
        }
        
        window.deleteUserAsAdmin = function(username) {
            if (!confirm(`Вы уверены, что хотите удалить пользователя @${username}? Все его данные будут удалены.`)) {
                return;
            }
            
            try {
                const user = users.find(u => u.username === username);
                if (!user) {
                    showNotification('Пользователь не найден', 'error');
                    return;
                }
                
                user.isDeleted = true;
                user.deletedAt = new Date().toISOString();
                
                saveUserToFirebase(user).then(() => {
                    const userToDelete = {
                        username: user.username,
                        name: user.name,
                        deletedAt: user.deletedAt,
                        secretWord: user.secretWord
                    };
                    
                    deletedUsers = deletedUsers.filter(u => u.username !== user.username);
                    deletedUsers.push(userToDelete);
                    localStorage.setItem('5bHouseDeletedUsers', JSON.stringify(deletedUsers));
                    
                    showNotification(`Пользователь ${user.name} удален`, 'success');
                    loadAdminUsers();
                });
                
            } catch (error) {
                console.error('Ошибка удаления пользователя:', error);
                showNotification('Ошибка удаления пользователя', 'error');
            }
        };
        
        window.restoreUserAsAdmin = function(username) {
            try {
                const deletedUser = deletedUsers.find(u => u.username === username);
                
                if (!deletedUser) {
                    showNotification('Удаленный пользователь не найден', 'error');
                    return;
                }
                
                const restoredUser = {
                    username: deletedUser.username,
                    name: deletedUser.name,
                    password: 'restored_' + Date.now(),
                    secretWord: deletedUser.secretWord,
                    isGroup: false,
                    isBlocked: false,
                    blockUntil: null,
                    isDeleted: false,
                    restoredAt: new Date().toISOString()
                };
                
                saveUserToFirebase(restoredUser).then(() => {
                    const userIndex = users.findIndex(u => u.username === username);
                    if (userIndex !== -1) {
                        users[userIndex] = restoredUser;
                    } else {
                        users.push(restoredUser);
                    }
                    
                    deletedUsers = deletedUsers.filter(u => u.username !== username);
                    localStorage.setItem('5bHouseDeletedUsers', JSON.stringify(deletedUsers));
                    
                    showNotification(`Пользователь ${restoredUser.name} восстановлен`, 'success');
                    loadAdminUsers();
                });
                
            } catch (error) {
                console.error('Ошибка восстановления пользователя:', error);
                showNotification('Ошибка восстановления пользователя', 'error');
            }
        };
        
        async function loadAdminGroupMessages() {
            try {
                const messagesList = document.getElementById('adminGroupMessages');
                
                const groupMessages = messages['5b_group'] || [];
                
                if (groupMessages.length === 0) {
                    messagesList.innerHTML = '<div class="empty-state">Нет сообщений в группе</div>';
                    return;
                }
                
                const sortedMessages = groupMessages.sort((a, b) => 
                    (b.timestamp || 0) - (a.timestamp || 0)
                );
                
                messagesList.innerHTML = '';
                
                sortedMessages.forEach(message => {
                    const sender = users.find(u => u.username === message.sender);
                    const senderName = sender ? sender.name : message.sender;
                    
                    const messageTime = message.time || 
                        (message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '');
                    
                    let messageContent = '';
                    
                    if (message.isDeleted) {
                        messageContent = '<div style="opacity: 0.6; font-style: italic;">⚠️ Сообщение удалено</div>';
                    } else if (message.type === 'text') {
                        messageContent = escapeHtml(message.text);
                    } else if (message.type === 'image') {
                        messageContent = '<div style="color: var(--primary-color);">📷 Фото</div>';
                    } else if (message.type === 'voice') {
                        messageContent = '<div style="color: var(--primary-color);">🎤 Голосовое сообщение</div>';
                    } else if (message.type === 'sticker') {
                        messageContent = `<div style="font-size: 24px;">${message.text}</div>`;
                    }
                    
                    const messageItem = document.createElement('div');
                    messageItem.className = 'admin-message-item';
                    
                    messageItem.innerHTML = `
                        <div class="admin-message-header">
                            <div class="admin-message-sender">${senderName}</div>
                            <div class="admin-message-time">${messageTime}</div>
                        </div>
                        <div class="admin-message-content">
                            ${messageContent}
                        </div>
                        ${!message.isDeleted ? `
                            <div class="admin-message-actions">
                                <button class="admin-btn delete" onclick="deleteGroupMessageAsAdmin('${message.id}')">
                                    Удалить сообщение
                                </button>
                            </div>
                        ` : ''}
                    `;
                    
                    messagesList.appendChild(messageItem);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки сообщений группы:', error);
                document.getElementById('adminGroupMessages').innerHTML = 
                    '<div class="empty-state">Ошибка загрузки сообщений</div>';
            }
        }
        
        window.deleteGroupMessageAsAdmin = function(messageId) {
            if (!confirm('Вы уверены, что хотите удалить это сообщение? Оно будет удалено навсегда.')) {
                return;
            }
            
            try {
                const groupMessages = messages['5b_group'] || [];
                const message = groupMessages.find(m => m.id === messageId);
                
                if (!message) {
                    showNotification('Сообщение не найдено', 'error');
                    return;
                }
                
                message.isDeleted = true;
                message.deletedAt = new Date().toISOString();
                message.deletedByAdmin = true;
                
                db.collection('messages').doc(message.id).update({
                    isDeleted: true,
                    deletedAt: message.deletedAt,
                    deletedByAdmin: true
                }).then(() => {
                    showNotification('Сообщение удалено', 'success');
                    loadAdminGroupMessages();
                });
                
            } catch (error) {
                console.error('Ошибка удаления сообщения:', error);
                showNotification('Ошибка удаления сообщения', 'error');
            }
        };

        // === ФУНКЦИИ ЭКРАНА НАСТРОЕК ===
        
        function showSettingsScreen() {
            document.getElementById('settingsScreen').classList.add('active');
            updateSettingsUI();
            hideMessageInput();
            hideChatMenu();
            hideCallTypeSelector();
        }

        function hideSettingsScreen() {
            document.getElementById('settingsScreen').classList.remove('active');
        }

        function updateSettingsUI() {
            if (!currentUser) return;
            
            document.getElementById('currentUsername').textContent = currentUser.username;
            document.getElementById('currentName').textContent = currentUser.name;
            
            if (isDarkTheme) {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
            
            updateUserPhoto();
            
            const photoPreview = document.getElementById('photoPreview');
            const photoPreviewImg = document.getElementById('photoPreviewImg');
            
            if (photoPreviewImg.src) {
                photoPreview.style.cursor = 'pointer';
                photoPreview.onclick = () => {
                    window.openMobileMedia(photoPreviewImg.src);
                };
            }
        }

        // === МЕНЮ ЧАТА ===
        
        function toggleChatMenu() {
            const chatMenu = document.getElementById('chatMenu');
            chatMenu.classList.toggle('active');
        }
        
        function hideChatMenu() {
            document.getElementById('chatMenu').classList.remove('active');
        }
        
        document.addEventListener('click', function(e) {
            const chatMenu = document.getElementById('chatMenu');
            const chatMenuBtn = document.getElementById('chatMenuBtn');
            
            if (chatMenu.classList.contains('active') && 
                !chatMenu.contains(e.target) && 
                e.target !== chatMenuBtn) {
                hideChatMenu();
            }
        });

        // === АВТОМАТИЧЕСКОЕ ДОБАВЛЕНИЕ НЕЗНАКОМЦЕВ ===
        
        async function checkAndAddStranger(message) {
            if (!currentUser || message.sender === currentUser.username) return;
            
            const sender = users.find(u => u.username === message.sender);
            if (!sender || sender.isGroup || sender.isDeleted) return;
            
            const userContacts = contacts[currentUser.username] || [];
            
            if (!userContacts.includes(sender.username)) {
                userContacts.push(sender.username);
                await saveContactsToFirebase(currentUser.username, userContacts);
                contacts[currentUser.username] = userContacts;
                
                showNotification(`${sender.name} автоматически добавлен в контакты`, 'info');
                
                setTimeout(() => {
                    loadMobileContacts();
                }, 100);
            }
        }

        // === УДАЛЕНИЕ ИЗ КОНТАКТОВ ===
        
        async function removeFromContacts() {
            if (!currentChat || !currentUser) return;
            
            const contact = users.find(u => u.username === currentChat);
            if (!contact) return;
            
            if (contact.isGroup) {
                showNotification('Нельзя удалить группу из контактов', 'error');
                return;
            }
            
            showConfirmModal(
                'Удалить из контактов',
                `Вы уверены, что хотите удалить ${contact.name} из списка контактов? После удаления вы перестанете видеть этого пользователя в списке контактов.`,
                'warning',
                async () => {
                    try {
                        const userContacts = contacts[currentUser.username] || [];
                        const updatedContacts = userContacts.filter(username => username !== currentChat);
                        
                        await saveContactsToFirebase(currentUser.username, updatedContacts);
                        contacts[currentUser.username] = updatedContacts;
                        
                        showNotification(`${contact.name} удален из контактов`, 'success');
                        
                        document.getElementById('chatScreen').classList.remove('active');
                        currentChat = null;
                        currentChatId = null;
                        hideMessageInput();
                        hideChatMenu();
                        
                        const chatId = getChatId(contact);
                        if (messages[chatId]) {
                            delete messages[chatId];
                        }
                        
                        setTimeout(() => {
                            loadMobileContacts();
                        }, 100);
                        
                    } catch (error) {
                        console.error('Ошибка удаления из контактов:', error);
                        showNotification('Ошибка удаления из контактов', 'error');
                    }
                }
            );
        }

        // === НЕЗНАКОМЦЫ ===
        
        function showStrangerNotification(contact) {
            const contactsList = document.getElementById('mobileContactsList');
            
            const existingNotification = contactsList.querySelector(`[data-stranger-username="${contact.username}"]`);
            if (existingNotification) {
                return;
            }
            
            const strangerNotification = document.createElement('div');
            strangerNotification.className = 'stranger-notification';
            strangerNotification.dataset.strangerUsername = contact.username;
            
            const userPhoto = contact.photo || null;
            
            strangerNotification.innerHTML = `
                <div class="stranger-notification-content">
                    <div class="stranger-notification-header">
                        <span>⚠️</span>
                        <div class="stranger-notification-text">
                            <strong>Незнакомец</strong>
                            <div style="font-size: 12px; opacity: 0.8;">${contact.name} добавлен в контакты автоматически</div>
                        </div>
                    </div>
                    <div class="stranger-notification-actions">
                        <button class="btn btn-secondary" id="removeStrangerBtn_${contact.username}">
                            Удалить
                        </button>
                        <button class="btn btn-primary" id="keepStrangerBtn_${contact.username}">
                            Оставить в контактах
                        </button>
                    </div>
                </div>
            `;
            
            const firstContactCard = contactsList.querySelector('.contact-card');
            if (firstContactCard) {
                contactsList.insertBefore(strangerNotification, firstContactCard);
            } else {
                contactsList.appendChild(strangerNotification);
            }
            
            document.getElementById(`removeStrangerBtn_${contact.username}`).addEventListener('click', async () => {
                await removeStrangerFromContacts(contact);
            });
            
            document.getElementById(`keepStrangerBtn_${contact.username}`).addEventListener('click', async () => {
                await addStrangerToContacts(contact);
                
                strangerNotification.remove();
                
                showNotification(`${contact.name} добавлен в контакты`, 'success');
                
                setTimeout(() => {
                    loadMobileContacts();
                }, 100);
            });
            
            setTimeout(() => {
                if (strangerNotification.parentNode) {
                    strangerNotification.remove();
                }
            }, 10000);
        }
        
        async function addStrangerToContacts(contact) {
            const userContacts = contacts[currentUser.username] || [];
            if (!userContacts.includes(contact.username)) {
                userContacts.push(contact.username);
                await saveContactsToFirebase(currentUser.username, userContacts);
                contacts[currentUser.username] = userContacts;
                
                const chatId = getChatId(contact);
                if (!messages[chatId]) {
                    messages[chatId] = [];
                }
                
                return true;
            }
            return false;
        }
        
        async function removeStrangerFromContacts(contact) {
            try {
                const userContacts = contacts[currentUser.username] || [];
                const updatedContacts = userContacts.filter(username => username !== contact.username);
                
                await saveContactsToFirebase(currentUser.username, updatedContacts);
                contacts[currentUser.username] = updatedContacts;
                
                const chatId = getChatId(contact);
                if (messages[chatId]) {
                    delete messages[chatId];
                }
                
                const notification = document.querySelector(`[data-stranger-username="${contact.username}"]`);
                if (notification) {
                    notification.remove();
                }
                
                showNotification(`${contact.name} удален из контактов`, 'success');
                
                if (currentChat === contact.username) {
                    document.getElementById('chatScreen').classList.remove('active');
                    currentChat = null;
                    currentChatId = null;
                    hideMessageInput();
                    hideChatMenu();
                }
                
                setTimeout(() => {
                    loadMobileContacts();
                }, 100);
                
            } catch (error) {
                console.error('Ошибка удаления незнакомца:', error);
                showNotification('Ошибка удаления из контактов', 'error');
            }
        }

        // === АУТЕНТИФИКАЦИЯ ===

        function showAuthForm(formId) {
            document.querySelectorAll('.auth-card').forEach(form => {
                form.classList.add('auth-hidden');
            });
            document.getElementById(formId).classList.remove('auth-hidden');
        }

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!username || !password) {
                showNotification('Заполните все поля', 'error');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = 'Вход...';
            loginBtn.disabled = true;
            
            try {
                await loadUsersFromFirebase();
                const user = users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    if (user.isDeleted) {
                        showNotification('Этот аккаунт был удален', 'error');
                        loginBtn.textContent = originalText;
                        loginBtn.disabled = false;
                        return;
                    }
                    
                    if (user.isBlocked) {
                        if (user.blockUntil && new Date(user.blockUntil) > new Date()) {
                            showNotification(`Аккаунт заблокирован до ${new Date(user.blockUntil).toLocaleString()}`, 'error');
                            loginBtn.textContent = originalText;
                            loginBtn.disabled = false;
                            return;
                        } else if (!user.blockUntil) {
                            showNotification('Аккаунт заблокирован навсегда', 'error');
                            loginBtn.textContent = originalText;
                            loginBtn.disabled = false;
                            return;
                        }
                    }
                    
                    if (user.isBlocked && user.blockUntil && new Date(user.blockUntil) <= new Date()) {
                        user.isBlocked = false;
                        user.blockUntil = null;
                        await saveUserToFirebase(user);
                    }
                    
                    currentUser = user;
                    localStorage.setItem('5bHouseCurrentUser', JSON.stringify(currentUser));
                    
                    await Promise.all([
                        loadContactsFromFirebase(),
                        loadMessagesFromFirebase()
                    ]);
                    
                    if (!users.find(u => u.username === '5b_group')) {
                        const groupUser = {
                            username: '5b_group',
                            name: '5Б Хаус - Общий чат класса',
                            password: 'group',
                            secretWord: 'group',
                            isGroup: true,
                            isBlocked: false,
                            blockUntil: null,
                            isDeleted: false
                        };
                        await saveUserToFirebase(groupUser);
                        users.push(groupUser);
                    }
                    
                    if (!contacts[currentUser.username]) {
                        contacts[currentUser.username] = [];
                    }
                    
                    if (!contacts[currentUser.username].includes('5b_group')) {
                        contacts[currentUser.username].push('5b_group');
                        await saveContactsToFirebase(currentUser.username, contacts[currentUser.username]);
                    }
                    
                    switchToApp();
                    showNotification(`Добро пожаловать, ${user.name}!`, 'success');
                    
                    // Показываем запрос на разрешение уведомлений после входа
                    setTimeout(() => {
                        if (Notification.permission === 'default') {
                            showNotificationPermissionRequest();
                        }
                    }, 2000);
                    
                } else {
                    showNotification('Неверный логин или пароль', 'error');
                }
                
            } catch (error) {
                console.error('Ошибка входа:', error);
                showNotification('Ошибка при входе. Проверьте подключение.', 'error');
            } finally {
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        }

        async function handleRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const secretWord = document.getElementById('registerSecretWord').value.trim();
            
            if (!username || !password || !name || !secretWord) {
                showNotification('Заполните все поля', 'error');
                return;
            }
            
            if (username.length < 3) {
                showNotification('Никнейм должен быть не менее 3 символов', 'error');
                return;
            }
            
            if (password.length < 4) {
                showNotification('Пароль должен быть не менее 4 символов', 'error');
                return;
            }
            
            if (secretWord.length < 4) {
                showNotification('Кодовое слово должно быть не менее 4 символов', 'error');
                return;
            }
            
            const registerBtn = document.getElementById('registerBtn');
            const originalText = registerBtn.textContent;
            registerBtn.textContent = 'Регистрация...';
            registerBtn.disabled = true;
            
            try {
                await loadUsersFromFirebase();
                
                if (users.find(u => u.username === username)) {
                    showNotification('Пользователь с таким никнеймом уже существует', 'error');
                    registerBtn.textContent = originalText;
                    registerBtn.disabled = false;
                    return;
                }
                
                const newUser = {
                    username: username,
                    password: password,
                    secretWord: secretWord,
                    name: name,
                    isGroup: false,
                    isBlocked: false,
                    blockUntil: null,
                    isDeleted: false,
                    createdAt: new Date().toISOString()
                };
                
                await saveUserToFirebase(newUser);
                users.push(newUser);
                
                contacts[username] = ['5b_group'];
                await saveContactsToFirebase(username, contacts[username]);
                
                currentUser = newUser;
                localStorage.setItem('5bHouseCurrentUser', JSON.stringify(newUser));
                
                switchToApp();
                showNotification(`Аккаунт успешно создан! Добро пожаловать, ${name}!`, 'success');
                
                // Показываем запрос на разрешение уведомлений после регистрации
                setTimeout(() => {
                    if (Notification.permission === 'default') {
                        showNotificationPermissionRequest();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                showNotification('Ошибка при регистрации. Попробуйте позже.', 'error');
            } finally {
                registerBtn.textContent = originalText;
                registerBtn.disabled = false;
            }
        }

        async function handleRecoverPassword() {
            const username = document.getElementById('recoverUsername').value.trim();
            const secretWord = document.getElementById('recoverSecretWord').value.trim();
            const newPassword = document.getElementById('recoverNewPassword').value.trim();
            
            if (!username || !secretWord || !newPassword) {
                showNotification('Заполните все поля', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showNotification('Пароль должен быть не менее 4 символов', 'error');
                return;
            }
            
            try {
                await loadUsersFromFirebase();
                const user = users.find(u => u.username === username);
                
                if (user) {
                    if (user.isDeleted) {
                        showNotification('Этот аккаунт был удален', 'error');
                        return;
                    }
                    
                    if (user.secretWord !== secretWord) {
                        showNotification('Неверное кодовое слово', 'error');
                        return;
                    }
                    
                    user.password = newPassword;
                    await saveUserToFirebase(user);
                    
                    showNotification('Пароль успешно изменен! Теперь вы можете войти.', 'success');
                    showAuthForm('loginForm');
                    
                    document.getElementById('recoverUsername').value = '';
                    document.getElementById('recoverSecretWord').value = '';
                    document.getElementById('recoverNewPassword').value = '';
                    
                } else {
                    showNotification('Пользователь не найден', 'error');
                }
                
            } catch (error) {
                console.error('Ошибка восстановления:', error);
                showNotification('Ошибка при восстановлении пароля', 'error');
            }
        }

        function handleLogout() {
            stopVoicePlayback();
            endCall();
            
            if (isRecording && mediaRecorder) {
                stopRecording();
                hideVoiceRecordingInterface();
            }
            
            // Очищаем все таймеры
            for (const timerId in deletedMessageTimers) {
                clearTimeout(deletedMessageTimers[timerId]);
            }
            deletedMessageTimers = {};
            
            currentUser = null;
            localStorage.removeItem('5bHouseCurrentUser');
            
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('authContainer').style.display = 'flex';
            showAuthForm('loginForm');
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showNotification('Вы успешно вышли из аккаунта', 'info');
        }

        function switchToApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            hideMessageInput();
            updateMobileUI();
            setupMobileMessageListener();
            loadMobileContacts();
            initMobileEmojiPicker();
            initMobileStickerPicker();
            setupKeyboardDetection();
            setupMessageClickHandlers();
            setupIncomingCallListener();
        }

        // === ИСПРАВЛЕНИЕ ПРОБЛЕМЫ С КЛАВИАТУРОЙ ===
        
        function setupKeyboardDetection() {
            const messageInput = document.getElementById('mobileMessageInput');
            const messagesContainer = document.getElementById('mobileMessagesContainer');
            
            messageInput.addEventListener('focus', function() {
                document.body.classList.add('keyboard-open');
                messagesContainer.classList.add('mobile-keyboard-open');
                
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    messagesContainer.style.paddingBottom = '150px';
                }, 300);
            });
            
            messageInput.addEventListener('blur', function() {
                document.body.classList.remove('keyboard-open');
                messagesContainer.classList.remove('mobile-keyboard-open');
                messagesContainer.style.paddingBottom = '70px';
            });
            
            let viewportHeight = window.innerHeight;
            window.addEventListener('resize', function() {
                const newViewportHeight = window.innerHeight;
                
                if (Math.abs(viewportHeight - newViewportHeight) > 200) {
                    document.body.classList.add('keyboard-open');
                    messagesContainer.classList.add('mobile-keyboard-open');
                    
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                }
                
                viewportHeight = newViewportHeight;
            });
        }

        // === FIREBASE ФУНКЦИИ ===

        async function loadUsersFromFirebase() {
            try {
                const snapshot = await db.collection('users').get();
                users = [];
                snapshot.forEach(doc => {
                    const user = doc.data();
                    user.photo = user.photo || null;
                    users.push(user);
                });
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                throw error;
            }
        }

        async function loadMessagesFromFirebase() {
            try {
                const snapshot = await db.collection('messages').get();
                messages = {};
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    if (!messages[msg.chatId]) messages[msg.chatId] = [];
                    if (!messages[msg.chatId].find(m => m.id === msg.id)) {
                        messages[msg.chatId].push(msg);
                    }
                });
            } catch (error) {
                console.error('Ошибка загрузки сообщений:', error);
                throw error;
            }
        }

        async function loadContactsFromFirebase() {
            try {
                const snapshot = await db.collection('contacts').get();
                contacts = {};
                snapshot.forEach(doc => {
                    contacts[doc.id] = doc.data().contacts || [];
                });
            } catch (error) {
                console.error('Ошибка загрузки контактов:', error);
                throw error;
            }
        }

        async function saveUserToFirebase(user) {
            try {
                await db.collection('users').doc(user.username).set(user);
            } catch (error) {
                console.error('Ошибка сохранения пользователя:', error);
                throw error;
            }
        }

        async function saveContactsToFirebase(username, contactList) {
            try {
                await db.collection('contacts').doc(username).set({
                    contacts: contactList
                });
            } catch (error) {
                console.error('Ошибка сохранения контактов:', error);
                throw error;
            }
        }

        async function saveMessageToFirebase(message, chatId) {
            try {
                const messageToSave = {
                    ...message,
                    chatId: chatId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('messages').doc(message.id).set(messageToSave);
                
                // Получаем информацию о чате
                const contact = users.find(u => u.username === currentChat);
                const senderUser = users.find(u => u.username === message.sender);
                
                // Отправляем уведомления
                if (contact) {
                    if (contact.isGroup) {
                        // Для группового чата отправляем всем кроме отправителя
                        const notificationTitle = `👥 ${contact.name}`;
                        const notificationBody = `${senderUser ? senderUser.name : message.sender}: ${message.type === 'text' ? message.text : 'Новое сообщение'}`;
                        
                        // Показываем локальное уведомление
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification(notificationTitle, {
                                body: notificationBody,
                                icon: 'https://cdn-icons-png.flaticon.com/512/124/124010.png'
                            });
                        }
                        
                    } else {
                        // Для личного чата отправляем только получателю
                        const notificationTitle = `💬 ${senderUser ? senderUser.name : message.sender}`;
                        const notificationBody = message.type === 'text' ? message.text : 'Новое сообщение';
                        
                        // Показываем локальное уведомление
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification(notificationTitle, {
                                body: notificationBody,
                                icon: 'https://cdn-icons-png.flaticon.com/512/124/124010.png'
                            });
                        }
                    }
                }
                
                // Проигрываем звук сообщения
                if (message.sender !== currentUser.username) {
                    playMessageSound();
                }
                
                return true;
            } catch (error) {
                console.error('Ошибка сохранения сообщения:', error);
                throw error;
            }
        }

        // === ФУНКЦИИ UI ===

        function updateMobileUI() {
            if (!currentUser) return;
            
            document.getElementById('mobileUserName').textContent = currentUser.name;
            updateUserPhoto();
            document.getElementById('mobileUserStatus').textContent = 'Онлайн';
            
            const avatar = document.getElementById('mobileAvatar');
            if (userPhoto) {
                avatar.style.cursor = 'pointer';
                avatar.onclick = () => {
                    window.openMobileMedia(userPhoto);
                };
            }
        }

        function loadMobileContacts() {
            const contactsList = document.getElementById('mobileContactsList');
            const activeTab = document.querySelector('.tab-button.active').dataset.tab;
            
            contactsList.innerHTML = '';
            
            if (!currentUser) {
                contactsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🔒</div>
                        <div class="empty-text">Войдите в аккаунт</div>
                    </div>
                `;
                return;
            }
            
            const userContacts = contacts[currentUser.username] || [];
            const searchQuery = document.getElementById('mobileSearchInput').value.toLowerCase();
            
            let filteredContacts = userContacts.filter(username => {
                const user = users.find(u => u.username === username);
                if (!user) return false;
                
                if (user.isDeleted) return false;
                
                if (activeTab === 'groups' && !user.isGroup) return false;
                if (activeTab === 'contacts' && user.isGroup) return false;
                
                if (searchQuery) {
                    const name = user.name.toLowerCase();
                    return name.includes(searchQuery);
                }
                
                return true;
            });
            
            if (activeTab === 'contacts') {
                const allChats = Object.keys(messages);
                allChats.forEach(chatId => {
                    if (chatId.startsWith('private_')) {
                        const usernames = chatId.replace('private_', '').split('_');
                        if (usernames.includes(currentUser.username)) {
                            const otherUser = usernames.find(u => u !== currentUser.username);
                            if (otherUser && !userContacts.includes(otherUser)) {
                                const stranger = users.find(u => u.username === otherUser);
                                if (stranger && !stranger.isDeleted && !stranger.isGroup) {
                                    if (!searchQuery || stranger.name.toLowerCase().includes(searchQuery)) {
                                        if (!filteredContacts.includes(otherUser)) {
                                            filteredContacts.push(otherUser);
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
                
                filteredContacts = [...new Set(filteredContacts)];
            }
            
            if (activeTab === 'groups') {
                const groupChat = users.find(u => u.username === '5b_group');
                if (groupChat && (!searchQuery || groupChat.name.toLowerCase().includes(searchQuery))) {
                    if (!filteredContacts.includes('5b_group')) {
                        filteredContacts.unshift('5b_group');
                    }
                }
            }
            
            if (activeTab === 'contacts') {
                const allChats = Object.keys(messages);
                allChats.forEach(chatId => {
                    if (chatId.startsWith('private_')) {
                        const usernames = chatId.replace('private_', '').split('_');
                        if (usernames.includes(currentUser.username)) {
                            const otherUser = usernames.find(u => u !== currentUser.username);
                            if (otherUser && !userContacts.includes(otherUser)) {
                                const stranger = users.find(u => u.username === otherUser);
                                if (stranger && !stranger.isDeleted && !stranger.isGroup) {
                                    if (!contacts[currentUser.username]?.includes(stranger.username)) {
                                        showStrangerNotification(stranger);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            if (filteredContacts.length === 0) {
                const nonGroupContacts = userContacts.filter(username => {
                    const user = users.find(u => u.username === username);
                    return user && !user.isGroup && !user.isDeleted;
                });
                
                if (activeTab === 'contacts' && nonGroupContacts.length === 0 && !searchQuery) {
                    contactsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">👤</div>
                            <div class="empty-text">Нет контактов</div>
                            <div class="empty-subtext">Добавьте контакты через кнопку ниже</div>
                            <div class="empty-action">
                                <button class="btn btn-primary" id="addContactEmptyBtn">
                                    + Добавить контакт
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('addContactEmptyBtn').addEventListener('click', handleAddContact);
                } else {
                    contactsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">${activeTab === 'groups' ? '👥' : '👤'}</div>
                            <div class="empty-text">
                                ${searchQuery ? 'Ничего не найдено' : 
                                  activeTab === 'groups' ? 'Нет групповых чатов' : 'Нет контактов'}
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            filteredContacts.sort((a, b) => {
                const userA = users.find(u => u.username === a);
                const userB = users.find(u => u.username === b);
                
                if (userA.isGroup && !userB.isGroup) return -1;
                if (!userA.isGroup && userB.isGroup) return 1;
                
                const chatIdA = getChatId(userA);
                const chatIdB = getChatId(userB);
                const lastMessageA = messages[chatIdA] ? Math.max(...messages[chatIdA].map(m => m.timestamp || 0)) : 0;
                const lastMessageB = messages[chatIdB] ? Math.max(...messages[chatIdB].map(m => m.timestamp || 0)) : 0;
                
                return lastMessageB - lastMessageA;
            });
            
            filteredContacts.forEach(username => {
                const user = users.find(u => u.username === username);
                if (!user) return;
                
                const chatId = getChatId(user);
                const chatMessages = messages[chatId] || [];
                const lastMessage = chatMessages[chatMessages.length - 1];
                const unreadCount = chatMessages.filter(m => 
                    m.sender !== currentUser.username && 
                    !m.readBy?.includes(currentUser.username)
                ).length;
                
                const contactCard = document.createElement('div');
                contactCard.className = 'contact-card';
                
                const isStranger = !contacts[currentUser.username]?.includes(username) && !user.isGroup;
                if (isStranger) {
                    contactCard.classList.add('stranger');
                }
                
                if (currentChat === username) {
                    contactCard.classList.add('active');
                }
                
                let lastMessageTime = '';
                if (lastMessage && lastMessage.timestamp) {
                    const date = new Date(lastMessage.timestamp);
                    const now = new Date();
                    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        lastMessageTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    } else if (diffDays === 1) {
                        lastMessageTime = 'Вчера';
                    } else if (diffDays < 7) {
                        const days = ['вс', 'пн', 'вт', 'ср', 'чт', 'пн', 'сб'];
                        lastMessageTime = days[date.getDay()];
                    } else {
                        lastMessageTime = date.toLocaleDateString();
                    }
                }
                
                let lastMessageText = lastMessage ? 
                    (lastMessage.type === 'text' ? lastMessage.text : 
                     lastMessage.type === 'image' ? '📷 Фото' :
                     lastMessage.type === 'voice' ? '🎤 Голосовое сообщение' :
                     lastMessage.type === 'sticker' ? '🎨 Стикер' : 'Сообщение') : 
                    'Нет сообщений';
                
                if (lastMessageText.length > 40) {
                    lastMessageText = lastMessageText.substring(0, 40) + '...';
                }
                
                const userPhoto = user.photo || null;
                
                contactCard.innerHTML = `
                    <div class="contact-avatar ${user.isGroup ? 'group-avatar' : ''} ${userPhoto ? 'has-photo' : ''}">
                        ${userPhoto ? `<img src="${userPhoto}" alt="${user.name}">` : user.name.charAt(0).toUpperCase()}
                        ${!user.isGroup ? '<div class="online-dot"></div>' : ''}
                        ${isStranger ? '<div class="stranger-indicator">!</div>' : ''}
                    </div>
                    <div class="contact-info">
                        <h4>${user.name} ${isStranger ? '<span style="color: var(--danger-color); font-size: 12px;">(Незнакомец)</span>' : ''}</h4>
                        <p>${lastMessageText}</p>
                        ${lastMessageTime ? `
                            <div class="last-message-time">
                                ${lastMessageTime}
                            </div>
                        ` : ''}
                    </div>
                    ${unreadCount > 0 ? `
                        <div class="unread-badge">
                            ${unreadCount}
                        </div>
                    ` : ''}
                `;
                
                contactCard.addEventListener('click', () => openMobileChat(user));
                contactsList.appendChild(contactCard);
            });
        }

        async function openMobileChat(contact) {
            currentChat = contact.username;
            currentChatId = getChatId(contact);
            
            const userContacts = contacts[currentUser.username] || [];
            const isInContacts = userContacts.includes(contact.username);
            
            if (!isInContacts && !contact.isGroup) {
                userContacts.push(contact.username);
                await saveContactsToFirebase(currentUser.username, userContacts);
                contacts[currentUser.username] = userContacts;
                
                showNotification(`${contact.name} автоматически добавлен в контакты`, 'info');
                
                setTimeout(() => {
                    loadMobileContacts();
                }, 100);
            }
            
            const removeBtn = document.getElementById('removeFromContactsBtn');
            if (contact.isGroup) {
                removeBtn.style.display = 'none';
            } else {
                removeBtn.style.display = 'block';
            }
            
            if (isRecording && mediaRecorder) {
                stopRecording();
                hideVoiceRecordingInterface();
            }
            stopVoicePlayback();
            
            document.getElementById('chatScreen').classList.add('active');
            showMessageInput();
            hideChatMenu();
            
            // Сбрасываем реплай при смене чата
            cancelReply();
            
            const chatAvatar = document.getElementById('chatAvatar');
            const userPhoto = contact.photo || null;
            if (userPhoto) {
                chatAvatar.innerHTML = `<img src="${userPhoto}" alt="${contact.name}">`;
                chatAvatar.classList.add('has-photo');
                chatAvatar.onclick = () => {
                    window.openMobileMedia(userPhoto);
                };
            } else {
                chatAvatar.innerHTML = contact.name.charAt(0).toUpperCase();
                chatAvatar.classList.remove('has-photo');
                chatAvatar.onclick = null;
            }
            
            document.getElementById('chatTitle').textContent = contact.name;
            document.getElementById('chatStatusText').textContent = contact.isGroup ? 'Группа' : 'Онлайн';
            
            loadMobileMessages();
            
            setTimeout(() => {
                const messagesContainer = document.getElementById('mobileMessagesContainer');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
            markMessagesAsRead();
        }

        function addMobileMessage(message, showSender = true) {
            const messagesContainer = document.getElementById('mobileMessagesContainer');
            const isOutgoing = message.sender === currentUser.username;
            
            const emptyState = messagesContainer.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isOutgoing ? 'message-outgoing' : 'message-incoming'}`;
            messageDiv.dataset.messageId = message.id;
            
            let senderName = '';
            if (showSender && !isOutgoing) {
                const sender = users.find(u => u.username === message.sender);
                senderName = sender ? sender.name : message.sender;
            }
            
            let messageContent = '';
            let replyPreview = '';
            
            // Добавляем превью реплая, если есть
            if (message.replyTo && message.replyToMessage) {
                const replySender = users.find(u => u.username === message.replyToMessage.sender);
                const replySenderName = replySender ? replySender.name : message.replyToMessage.sender;
                
                let replyText = message.replyToMessage.text || '';
                if (message.replyToMessage.type === 'image') replyText = '📷 Фото';
                if (message.replyToMessage.type === 'voice') replyText = '🎤 Голосовое сообщение';
                if (message.replyToMessage.type === 'sticker') replyText = '🎨 Стикер';
                
                if (replyText.length > 50) {
                    replyText = replyText.substring(0, 50) + '...';
                }
                
                replyPreview = `
                    <div class="reply-preview">
                        <div class="reply-sender">${replySenderName}</div>
                        <div class="reply-text">${escapeHtml(replyText)}</div>
                    </div>
                `;
            }
            
            // Добавляем кнопки пересылки и копирования (для текстовых сообщений) в том же окне
            let actionButtons = '';
            if (!message.isDeleted) {
                if (isOutgoing) {
                    actionButtons += `
                        <button class="forward-circle-btn" onclick="forwardMessage('${message.id}')" title="Переслать">
                            ↪️
                        </button>
                    `;
                    if (message.type === 'text') {
                        actionButtons += `
                            <button class="copy-message-circle-btn" onclick="copyMessage('${message.id}')" title="Копировать">
                                📋
                            </button>
                        `;
                    }
                } else {
                    actionButtons += `
                        <button class="forward-circle-btn" onclick="forwardMessage('${message.id}')" title="Переслать">
                            ↪️
                        </button>
                    `;
                    if (message.type === 'text') {
                        actionButtons += `
                            <button class="copy-message-circle-btn" onclick="copyMessage('${message.id}')" title="Копировать">
                                📋
                            </button>
                        `;
                    }
                }
            }
            
            if (message.isDeleted) {
                messageContent = `
                    <div class="message-text" style="opacity: 0.6; font-style: italic;">
                        ⚠️ Сообщение удалено
                    </div>
                `;
            } else if (message.type === 'text') {
                let textContent = message.text;
                if (message.edited) {
                    textContent += ' (ред.)';
                }
                if (message.isForwarded) {
                    const originalSender = users.find(u => u.username === message.originalSender);
                    const senderName = originalSender ? originalSender.name : message.originalSender;
                    textContent = `↪️ Переслано от ${senderName}:\n${textContent}`;
                }
                
                messageContent = `
                    ${senderName ? `<div class="message-sender">${senderName}</div>` : ''}
                    ${replyPreview}
                    <div class="message-text">${escapeHtml(textContent)}</div>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        ${actionButtons}
                    </div>
                `;
            } else if (message.type === 'image') {
                messageContent = `
                    ${senderName ? `<div class="message-sender">${senderName}</div>` : ''}
                    ${replyPreview}
                    <div class="media-message">
                        <img src="${message.data}" class="media-image" onclick="openMobileMedia('${message.data}')">
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            } else if (message.type === 'voice') {
                const duration = message.duration || 1;
                const formattedDuration = formatVoiceTime(duration);
                const waveformBars = createWaveformBars(duration);
                
                messageContent = `
                    ${senderName ? `<div class="message-sender">${senderName}</div>` : ''}
                    ${replyPreview}
                    <div class="voice-message">
                        <button class="voice-play-button" onclick="toggleVoicePlayback('${message.id}')">
                            <span class="voice-play-icon">▶</span>
                        </button>
                        <div class="voice-info">
                            <div class="voice-waveform">
                                <div class="voice-wave">
                                    ${waveformBars}
                                </div>
                                <div class="wave-progress" style="width: 0%"></div>
                            </div>
                            <div class="voice-duration">
                                <span class="current-time">00:00</span>
                                <span>${formattedDuration}</span>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        ${actionButtons}
                    </div>
                `;
            } else if (message.type === 'sticker') {
                messageContent = `
                    ${replyPreview}
                    <div style="text-align: center; padding: 10px; position: relative;">
                        <div style="font-size: 48px;">${message.text}</div>
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            } else {
                messageContent = `
                    ${senderName ? `<div class="message-sender">${senderName}</div>` : ''}
                    ${replyPreview}
                    <div class="message-text">${escapeHtml(message.text || 'Медиа-сообщение')}</div>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        ${actionButtons}
                    </div>
                `;
            }
            
            const time = message.time || formatMessageTime(message.timestamp);
            
            // Кнопки действий для расширенного меню
            let expandedActionButtons = '';
            if (!message.isDeleted) {
                if (isOutgoing) {
                    expandedActionButtons = `
                        <button class="message-action-btn edit-message-btn" onclick="editMessage('${message.id}')">
                            <span class="tooltip">Редактировать</span>
                            ✏️
                        </button>
                        <button class="message-action-btn delete-message-btn" onclick="deleteMessageForEveryone('${message.id}')">
                            <span class="tooltip">Удалить для всех</span>
                            ×
                        </button>
                        <button class="message-action-btn forward-message-btn" onclick="forwardMessage('${message.id}')">
                            <span class="tooltip">Переслать</span>
                            ↪️
                        </button>
                        ${message.type === 'text' ? `
                            <button class="message-action-btn copy-message-btn" onclick="copyMessage('${message.id}')">
                                <span class="tooltip">Копировать</span>
                                📋
                            </button>
                        ` : ''}
                    `;
                } else {
                    expandedActionButtons = `
                        <button class="message-action-btn reply-message-btn" onclick="replyToMessage('${message.id}')">
                            <span class="tooltip">Ответить</span>
                            ↩️
                        </button>
                        <button class="message-action-btn forward-message-btn" onclick="forwardMessage('${message.id}')">
                            <span class="tooltip">Переслать</span>
                            ↪️
                        </button>
                        ${message.type === 'text' ? `
                            <button class="message-action-btn copy-message-btn" onclick="copyMessage('${message.id}')">
                                <span class="tooltip">Копировать</span>
                                📋
                            </button>
                        ` : ''}
                    `;
                }
            }
            
            const expandedContent = !message.isDeleted ? `
                <div class="message-expanded-content">
                    <div class="message-expanded-actions">
                        ${expandedActionButtons}
                    </div>
                </div>
            ` : '';
            
            messageDiv.innerHTML = `
                ${messageContent}
                ${expandedContent}
                <div class="message-time">
                    ${time}
                    ${isOutgoing && !message.isDeleted ? `
                        <span class="message-status">
                            ${message.readBy?.length > 0 ? '✓✓' : '✓'}
                        </span>
                    ` : ''}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            if (isOutgoing) {
                scrollToBottom();
            }
        }

        function loadMobileMessages() {
            const messagesContainer = document.getElementById('mobileMessagesContainer');
            messagesContainer.innerHTML = '';
            
            if (!currentChatId || !messages[currentChatId] || messages[currentChatId].length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">💬</div>
                        <div class="empty-text">Начните общение!</div>
                        <div class="empty-subtext">Отправьте первое сообщение</div>
                    </div>
                `;
                return;
            }
            
            const chatMessages = messages[currentChatId]
                .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            let lastSender = null;
            
            chatMessages.forEach(message => {
                addMobileMessage(message, lastSender !== message.sender);
                lastSender = message.sender;
            });
            
            scrollToBottom();
        }

        function sendMobileMessage() {
            const input = document.getElementById('mobileMessageInput');
            let text = input.value.trim();
            
            if (!text && !replyingToMessageId && !editingMessageId) return;
            
            if (editingMessageId) {
                // Редактирование существующего сообщения
                saveEditedMessage(text);
                input.value = '';
                resetTextareaHeight();
                document.getElementById('mobileSendBtn').disabled = true;
                editingMessageId = null;
                editingMessage = null;
                return;
            }
            
            const contact = users.find(u => u.username === currentChat);
            if (!contact) return;
            
            const chatId = getChatId(contact);
            const messageId = Date.now().toString();
            
            const message = {
                id: messageId,
                sender: currentUser.username,
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                timestamp: Date.now(),
                type: 'text',
                read: false,
                readBy: [],
                isDeleted: false,
                deletedForEveryone: false
            };
            
            // Добавляем информацию о реплае, если есть
            if (replyingToMessageId) {
                message.replyTo = replyingToMessageId;
                message.replyToMessage = {
                    id: replyingToMessage.id,
                    sender: replyingToMessage.sender,
                    text: replyingToMessage.text,
                    type: replyingToMessage.type
                };
            }
            
            if (expandedMessageId) {
                const expandedMessage = document.querySelector(`[data-message-id="${expandedMessageId}"]`);
                if (expandedMessage) {
                    expandedMessage.classList.remove('expanded');
                }
                expandedMessageId = null;
            }
            
            saveMessageToFirebase(message, chatId)
                .then(() => {
                    input.value = '';
                    resetTextareaHeight();
                    document.getElementById('mobileSendBtn').disabled = true;
                    showNotification('Сообщение отправлено!', 'success');
                    
                    // Сбрасываем реплай после отправки
                    if (replyingToMessageId) {
                        cancelReply();
                    }
                })
                .catch(error => {
                    console.error('Ошибка отправки:', error);
                    showNotification('Ошибка отправки', 'error');
                });
        }

        function setupMobileMessageListener() {
            db.collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const message = change.doc.data();
                            const chatId = message.chatId;
                            
                            if (!messages[chatId]) messages[chatId] = [];
                            const existingIndex = messages[chatId].findIndex(m => m.id === message.id);
                            
                            if (existingIndex === -1) {
                                messages[chatId].push(message);
                                
                                if (message.sender !== currentUser.username && !message.sender.endsWith('_group')) {
                                    checkAndAddStranger(message);
                                }
                                
                                if (chatId === currentChatId) {
                                    addMobileMessage(message);
                                    markMessagesAsRead();
                                }
                            } else {
                                messages[chatId][existingIndex] = message;
                                
                                if (chatId === currentChatId) {
                                    updateMessageUI(message.id);
                                }
                            }
                            
                            loadMobileContacts();
                        }
                    });
                });
        }

        function markMessagesAsRead() {
            if (!currentChatId || !messages[currentChatId]) return;
            
            const unreadMessages = messages[currentChatId].filter(m => 
                m.sender !== currentUser.username && 
                !m.readBy?.includes(currentUser.username)
            );
            
            unreadMessages.forEach(msg => {
                if (!msg.readBy) msg.readBy = [];
                msg.readBy.push(currentUser.username);
            });
            
            loadMobileContacts();
        }

        function getChatId(contact) {
            if (!contact || !currentUser) return null;
            
            if (contact.isGroup) {
                return contact.username;
            } else {
                const users = [currentUser.username, contact.username].sort();
                return `private_${users.join('_')}`;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            let icon = 'ℹ️';
            if (type === 'success') icon = '✅';
            if (type === 'error') icon = '❌';
            if (type === 'warning') icon = '⚠️';
            
            notification.innerHTML = `
                <span class="notification-icon">${icon}</span>
                <span>${message}</span>
                <button class="notification-close">×</button>
            `;
            
            document.body.appendChild(notification);
            
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // === ФУНКЦИЯ ДЛЯ ЗАПРОСА РАЗРЕШЕНИЯ УВЕДОМЛЕНИЙ ===
        
        function showNotificationPermissionRequest() {
            const permissionHTML = `
                <div class="push-notification-permission">
                    <div class="push-notification-content">
                        <div class="push-notification-header">
                            <span>🔔</span>
                            <span>Получайте уведомления о новых сообщениях</span>
                        </div>
                        <div style="font-size: 14px; opacity: 0.9;">
                            Включите push-уведомления, чтобы получать сообщения даже когда приложение закрыто
                        </div>
                        <div class="push-notification-actions">
                            <button class="btn btn-secondary" id="denyNotificationsBtn">
                                Не сейчас
                            </button>
                            <button class="btn btn-primary" id="allowNotificationsBtn">
                                Включить уведомления
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingPermission = document.querySelector('.push-notification-permission');
            if (existingPermission) {
                existingPermission.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', permissionHTML);
            
            document.getElementById('denyNotificationsBtn').addEventListener('click', () => {
                document.querySelector('.push-notification-permission').remove();
                showNotification('Вы можете включить уведомления позже в настройках', 'info');
            });
            
            document.getElementById('allowNotificationsBtn').addEventListener('click', async () => {
                document.querySelector('.push-notification-permission').remove();
                await initializeNotifications();
            });
            
            // Автоматически скрыть через 10 секунд
            setTimeout(() => {
                const permissionElement = document.querySelector('.push-notification-permission');
                if (permissionElement) {
                    permissionElement.remove();
                }
            }, 10000);
        }
        
        // === ФУНКЦИЯ ДЛЯ ТЕСТОВЫХ УВЕДОМЛЕНИЙ ===
        
        async function sendTestNotification() {
            if (!currentUser) return;
            
            try {
                const notificationTitle = 'Тестовое уведомление';
                const notificationBody = `Привет, ${currentUser.name}! Это тестовое уведомление от 5Б Хаус.`;
                
                // Показываем локальное уведомление
                if (Notification.permission === 'granted') {
                    const notification = new Notification(notificationTitle, {
                        body: notificationBody,
                        icon: 'https://cdn-icons-png.flaticon.com/512/124/124010.png',
                        badge: 'https://cdn-icons-png.flaticon.com/512/124/124010.png',
                        tag: 'test-notification',
                        requireInteraction: true
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        this.close();
                    };
                    
                    showNotification('Тестовое уведомление отправлено!', 'success');
                } else {
                    showNotification('Разрешите уведомления для отправки теста', 'warning');
                }
                
            } catch (error) {
                console.error('Ошибка отправки тестового уведомления:', error);
                showNotification('Ошибка отправки тестового уведомления', 'error');
            }
        }

        // === ИНИЦИАЛИЗАЦИЯ ===

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Приложение загружено');
            
            applyThemeOnLoad();
            deletedUsers = JSON.parse(localStorage.getItem('5bHouseDeletedUsers')) || [];
            homeworkData = JSON.parse(localStorage.getItem('5bHouseHomework')) || {};
            setupAuthEventListeners();
            
            const savedUser = localStorage.getItem('5bHouseCurrentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    await loadUsersFromFirebase();
                    await loadContactsFromFirebase();
                    await loadMessagesFromFirebase();
                    
                    const userExists = users.find(u => u.username === currentUser.username);
                    
                    if (userExists) {
                        if (userExists.isDeleted) {
                            showNotification('Этот аккаунт был удален', 'error');
                            currentUser = null;
                            localStorage.removeItem('5bHouseCurrentUser');
                            return;
                        }
                        
                        if (userExists.isBlocked) {
                            if (userExists.blockUntil && new Date(userExists.blockUntil) > new Date()) {
                                showNotification(`Аккаунт заблокирован до ${new Date(userExists.blockUntil).toLocaleString()}`, 'error');
                                currentUser = null;
                                localStorage.removeItem('5bHouseCurrentUser');
                                return;
                            } else if (!userExists.blockUntil) {
                                showNotification('Аккаунт заблокирован навсегда', 'error');
                                currentUser = null;
                                localStorage.removeItem('5bHouseCurrentUser');
                                return;
                            }
                        }
                        
                        if (userExists.isBlocked && userExists.blockUntil && new Date(userExists.blockUntil) <= new Date()) {
                            userExists.isBlocked = false;
                            userExists.blockUntil = null;
                            await saveUserToFirebase(userExists);
                        }
                        
                        switchToApp();
                        
                        // Проверяем уведомления после входа
                        if (Notification.permission === 'default') {
                            setTimeout(() => {
                                showNotificationPermissionRequest();
                            }, 2000);
                        }
                    } else {
                        currentUser = null;
                        localStorage.removeItem('5bHouseCurrentUser');
                        showNotification('Сессия истекла. Войдите заново.', 'info');
                    }
                    
                } catch (error) {
                    console.error('Ошибка восстановления сессии:', error);
                    currentUser = null;
                    localStorage.removeItem('5bHouseCurrentUser');
                }
            }
            
            setupMobileEventListeners();
        });

        function setupAuthEventListeners() {
            document.getElementById('showRegisterLink').addEventListener('click', (e) => {
                e.preventDefault();
                showAuthForm('registerForm');
            });
            
            document.getElementById('showLoginLink').addEventListener('click', (e) => {
                e.preventDefault();
                showAuthForm('loginForm');
            });
            
            document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
                e.preventDefault();
                showAuthForm('recoverForm');
            });
            
            document.getElementById('backToLoginFromRecover').addEventListener('click', (e) => {
                e.preventDefault();
                showAuthForm('loginForm');
            });
            
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('recoverBtn').addEventListener('click', handleRecoverPassword);
            
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.getElementById('registerPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
            
            document.getElementById('recoverNewPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRecoverPassword();
            });
        }

        function setupMobileEventListeners() {
            // Кнопка звонка в чате
            document.getElementById('callChatButton').addEventListener('click', showCallTypeSelector);
            
            // Выбор типа звонка
            document.getElementById('videoCallBtn').addEventListener('click', () => {
                hideCallTypeSelector();
                startCall('video');
            });
            
            document.getElementById('audioCallBtn').addEventListener('click', () => {
                hideCallTypeSelector();
                startCall('audio');
            });
            
            // Управление звонком
            document.getElementById('muteButton').addEventListener('click', toggleMute);
            document.getElementById('videoToggleButton').addEventListener('click', toggleVideo);
            document.getElementById('endCallButton').addEventListener('click', endCall);
            
            document.getElementById('backToContactsBtn').addEventListener('click', function() {
                document.getElementById('chatScreen').classList.remove('active');
                currentChat = null;
                currentChatId = null;
                hideEmojiStickerPanel();
                hideMessageInput();
                hideChatMenu();
                stopVoicePlayback();
                
                // Сбрасываем реплай при выходе из чата
                cancelReply();
                
                if (expandedMessageId) {
                    const expandedMessage = document.querySelector(`[data-message-id="${expandedMessageId}"]`);
                    if (expandedMessage) {
                        expandedMessage.classList.remove('expanded');
                    }
                    expandedMessageId = null;
                }
            });
            
            document.getElementById('backFromSettingsBtn').addEventListener('click', function() {
                hideSettingsScreen();
            });
            
            document.getElementById('studentCornerBtn').addEventListener('click', function() {
                showStudentCorner();
            });
            
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    loadMobileContacts();
                });
            });
            
            const searchInput = document.getElementById('mobileSearchInput');
            const searchActivator = document.getElementById('searchActivator');
            
            searchActivator.addEventListener('click', function() {
                showSearchModal();
            });
            
            function showSearchModal() {
                const modalHTML = `
                    <div class="modal-overlay">
                        <div class="modal">
                            <div class="modal-title">Поиск контактов</div>
                            <div class="form-group">
                                <label for="searchModalInput">Введите имя для поиска</label>
                                <input type="text" 
                                       id="searchModalInput" 
                                       placeholder="Введите имя контакта..."
                                       required
                                       autofocus>
                            </div>
                            <div class="info-box">
                                🔍 Поиск работает по именам контактов
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" id="cancelSearchBtn">Отмена</button>
                                <button class="btn btn-primary" id="applySearchBtn">Поиск</button>
                            </div>
                        </div>
                </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHTML;
                
                document.getElementById('cancelSearchBtn').addEventListener('click', () => {
                    document.getElementById('modalContainer').innerHTML = '';
                });
                
                document.getElementById('applySearchBtn').addEventListener('click', () => {
                    const searchValue = document.getElementById('searchModalInput').value.trim();
                    
                    if (searchValue) {
                        searchInput.value = searchValue;
                        loadMobileContacts();
                        document.getElementById('modalContainer').innerHTML = '';
                    }
                });
                
                document.getElementById('searchModalInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('applySearchBtn').click();
                    }
                });
            }
            
            searchInput.addEventListener('dblclick', function() {
                this.value = '';
                loadMobileContacts();
            });
            
            document.getElementById('mobileSendBtn').addEventListener('click', sendMobileMessage);
            
            document.getElementById('emojiBtnMobile').addEventListener('click', function() {
                if (document.getElementById('emojiStickerPanel').classList.contains('active') && 
                    document.getElementById('emojiSection').style.display === 'block') {
                    hideEmojiStickerPanel();
                } else {
                    showEmojiPanel();
                }
            });
            
            document.getElementById('stickerBtnMobile').addEventListener('click', function() {
                if (document.getElementById('emojiStickerPanel').classList.contains('active') && 
                    document.getElementById('stickerSection').style.display === 'block') {
                    hideEmojiStickerPanel();
                } else {
                    showStickerPanel();
                }
            });
            
            document.addEventListener('click', function(e) {
                const panel = document.getElementById('emojiStickerPanel');
                if (panel.classList.contains('active') && 
                    !e.target.closest('#emojiStickerPanel') && 
                    !e.target.closest('#emojiBtnMobile') && 
                    !e.target.closest('#stickerBtnMobile')) {
                    hideEmojiStickerPanel();
                }
            });
            
            document.getElementById('mediaBtnMobile').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*,video/*';
                input.onchange = (e) => handleMediaUpload(e.target.files[0]);
                input.click();
            });
            
            document.getElementById('voiceBtnMobile').addEventListener('click', handleVoiceMessage);
            
            document.getElementById('addContactBtn').addEventListener('click', handleAddContact);
            
            document.getElementById('logoutBtn').addEventListener('click', showLogoutConfirm);
            
            document.getElementById('mobileSettingsBtn').addEventListener('click', function() {
                showSettingsScreen();
            });
            
            document.getElementById('chatMenuBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleChatMenu();
            });
            
            document.getElementById('chatClearBtn').addEventListener('click', function() {
                hideChatMenu();
                showClearChatConfirm();
            });
            
            document.getElementById('removeFromContactsBtn').addEventListener('click', function() {
                hideChatMenu();
                removeFromContacts();
            });
            
            // Обработчик для кнопки отмены реплая
            document.getElementById('cancelReplyBtn').addEventListener('click', cancelReply);
            
            document.getElementById('themeToggleSettings').addEventListener('click', toggleTheme);
            document.getElementById('uploadPhotoBtn').addEventListener('click', uploadPhoto);
            document.getElementById('removePhotoBtn').addEventListener('click', removePhoto);
            document.getElementById('changeSecretWordBtn').addEventListener('click', showChangeSecretWordModal);
            document.getElementById('recoverDeletedAccountBtn').addEventListener('click', showRecoverDeletedAccountModal);
            document.getElementById('deleteAccountBtn').addEventListener('click', showDeleteAccountConfirm);
            document.getElementById('adminPanelBtn').addEventListener('click', showAdminPanel);
            
            // Обработчики для кнопок уведомлений
            document.getElementById('enableNotificationsBtn').addEventListener('click', async () => {
                await initializeNotifications();
            });
            
            document.getElementById('testNotificationBtn').addEventListener('click', async () => {
                await sendTestNotification();
            });
            
            document.getElementById('mobileAvatar').addEventListener('click', function() {
                if (userPhoto) {
                    window.openMobileMedia(userPhoto);
                } else {
                    showSettingsScreen();
                }
            });
            
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    document.getElementById('modalContainer').innerHTML = '';
                }
                if (e.target.classList.contains('call-container') && e.target.id === 'callContainer') {
                    // Предотвращаем закрытие интерфейса звонка при клике на фон
                    e.stopPropagation();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.getElementById('modalContainer').innerHTML = '';
                    if (callState === 'calling' || callState === 'connected') {
                        endCall();
                    }
                }
            });
            
            const messageInput = document.getElementById('mobileMessageInput');
            messageInput.addEventListener('input', function() {
                const sendBtn = document.getElementById('mobileSendBtn');
                const hasText = this.value.trim().length > 0;
                sendBtn.disabled = !hasText && !replyingToMessageId && !editingMessageId;
                adjustTextareaHeight(this);
            });
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!this.value.trim() && !replyingToMessageId && !editingMessageId) return;
                    
                    const sendBtn = document.getElementById('mobileSendBtn');
                    if (!sendBtn.disabled) {
                        sendMobileMessage();
                    }
                }
            });
        }

        function setupMessageClickHandlers() {
            document.getElementById('mobileMessagesContainer').addEventListener('click', function(e) {
                const messageElement = e.target.closest('.message-bubble');
                if (!messageElement) return;
                
                const messageId = messageElement.dataset.messageId;
                if (!messageId) return;
                
                if (e.target.closest('.message-action-btn') || 
                    e.target.closest('.voice-play-button') ||
                    e.target.closest('.media-image') ||
                    e.target.closest('.forward-circle-btn') ||
                    e.target.closest('.copy-message-circle-btn')) {
                    return;
                }
                
                window.toggleMessageExpansion(messageId);
            });
        }

        // === ДОБАВЛЕНИЕ КОНТАКТОВ ===
        
        async function handleAddContact() {
            if (!currentUser) return;
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal">
                        <div class="modal-title">Добавить контакт</div>
                        <div class="form-group">
                            <label for="contactUsernameModal">Никнейм пользователя</label>
                            <input type="text" 
                                   id="contactUsernameModal" 
                                   placeholder="Введите никнейм для поиска"
                                   required>
                        </div>
                        <div class="info-box" id="contactSearchResult" style="display: none;">
                            <!-- Результат поиска будет здесь -->
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="cancelAddContactBtn">Отмена</button>
                            <button class="btn btn-primary" id="searchContactBtn">Найти</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHTML;
            
            document.getElementById('cancelAddContactBtn').addEventListener('click', () => {
                document.getElementById('modalContainer').innerHTML = '';
            });
            
            document.getElementById('searchContactBtn').addEventListener('click', async () => {
                const username = document.getElementById('contactUsernameModal').value.trim();
                
                if (!username) {
                    showNotification('Введите никнейм для поиска', 'error');
                    return;
                }
                
                if (username === currentUser.username) {
                    showNotification('Нельзя добавить самого себя в контакты', 'error');
                    return;
                }
                
                try {
                    await loadUsersFromFirebase();
                    
                    const userToAdd = users.find(u => u.username === username);
                    
                    const resultBox = document.getElementById('contactSearchResult');
                    
                    if (!userToAdd) {
                        resultBox.innerHTML = `
                            <div style="color: var(--danger-color);">
                                ❌ Пользователь не найден
                            </div>
                        `;
                        resultBox.style.display = 'block';
                        return;
                    }
                    
                    if (userToAdd.isDeleted) {
                        resultBox.innerHTML = `
                            <div style="color: var(--danger-color);">
                                ❌ Этот аккаунт был удален
                            </div>
                        `;
                        resultBox.style.display = 'block';
                        return;
                    }
                    
                    if (userToAdd.isBlocked) {
                        if (userToAdd.blockUntil) {
                            resultBox.innerHTML = `
                                <div style="color: var(--warning-color);">
                                    ⚠️ Этот пользователь заблокирован до ${new Date(userToAdd.blockUntil).toLocaleString()}
                                </div>
                            `;
                        } else {
                            resultBox.innerHTML = `
                                <div style="color: var(--warning-color);">
                                    ⚠️ Этот пользователь заблокирован навсегда
                                </div>
                            `;
                        }
                        resultBox.style.display = 'block';
                        return;
                    }
                    
                    const userContacts = contacts[currentUser.username] || [];
                    if (userContacts.includes(username)) {
                        resultBox.innerHTML = `
                            <div style="color: var(--warning-color);">
                                ⚠️ Этот пользователь уже есть в ваших контактах
                            </div>
                        `;
                        resultBox.style.display = 'block';
                        return;
                    }
                    
                    const userPhoto = userToAdd.photo || null;
                    
                    resultBox.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); 
                                 display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; overflow: hidden;">
                                ${userPhoto ? `<img src="${userPhoto}" style="width: 100%; height: 100%; object-fit: cover;">` : userToAdd.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: bold;">${userToAdd.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">@${userToAdd.username}</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" id="confirmAddContactBtn" style="width: 100%;">
                                ✅ Добавить в контакты
                            </button>
                        </div>
                    `;
                    resultBox.style.display = 'block';
                    
                    document.getElementById('confirmAddContactBtn').addEventListener('click', async () => {
                        try {
                            userContacts.push(username);
                            await saveContactsToFirebase(currentUser.username, userContacts);
                            contacts[currentUser.username] = userContacts;
                            
                            document.getElementById('modalContainer').innerHTML = '';
                            
                            loadMobileContacts();
                            
                            showNotification(`Пользователь ${userToAdd.name} добавлен в контакты!`, 'success');
                            
                        } catch (error) {
                            console.error('Ошибка добавления контакта:', error);
                            showNotification('Ошибка добавления контакта', 'error');
                        }
                    });
                    
                } catch (error) {
                    console.error('Ошибка поиска пользователя:', error);
                    showNotification('Ошибка поиска пользователя', 'error');
                }
            });
        }

        // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===

        function initMobileEmojiPicker() {
            const grid = document.getElementById('mobileEmojiGrid');
            grid.innerHTML = '';
            
            emojis.forEach(emoji => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-item';
                emojiDiv.textContent = emoji;
                emojiDiv.addEventListener('click', () => {
                    insertEmoji(emoji);
                    hideEmojiStickerPanel();
                });
                grid.appendChild(emojiDiv);
            });
        }

        function initMobileStickerPicker() {
            const grid = document.getElementById('mobileStickerGrid');
            grid.innerHTML = '';
            
            stickers.forEach(sticker => {
                const stickerDiv = document.createElement('div');
                stickerDiv.className = 'sticker-item';
                stickerDiv.innerHTML = `<div>${sticker}</div>`;
                stickerDiv.addEventListener('click', async () => {
                    await sendMobileSticker(sticker);
                });
                grid.appendChild(stickerDiv);
            });
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('mobileMessageInput');
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + emoji + textAfter;
            
            document.getElementById('mobileSendBtn').disabled = input.value.trim().length === 0 && !replyingToMessageId && !editingMessageId;
            
            adjustTextareaHeight(input);
        }

        async function sendMobileSticker(sticker) {
            if (!currentChat) return;
            
            const contact = users.find(u => u.username === currentChat);
            const chatId = getChatId(contact);
            
            const messageId = Date.now().toString();
            const message = {
                id: messageId,
                sender: currentUser.username,
                text: sticker,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                timestamp: Date.now(),
                type: 'sticker',
                read: false,
                readBy: [],
                isDeleted: false
            };
            
            // Добавляем информацию о реплае, если есть
            if (replyingToMessageId) {
                message.replyTo = replyingToMessageId;
                message.replyToMessage = {
                    id: replyingToMessage.id,
                    sender: replyingToMessage.sender,
                    text: replyingToMessage.text,
                    type: replyingToMessage.type
                };
            }
            
            try {
                await saveMessageToFirebase(message, chatId);
                hideEmojiStickerPanel();
                showNotification('Стикер отправлен!', 'success');
                
                // Сбрасываем реплай
                if (replyingToMessageId) {
                    cancelReply();
                }
                
            } catch (error) {
                console.error('Ошибка отправки стикера:', error);
                showNotification('Ошибка отправки', 'error');
            }
        }

        function showEmojiPanel() {
            const panel = document.getElementById('emojiStickerPanel');
            document.getElementById('emojiSection').style.display = 'block';
            document.getElementById('stickerSection').style.display = 'none';
            panel.classList.add('active');
            
            document.getElementById('emojiBtnMobile').classList.add('active');
            document.getElementById('stickerBtnMobile').classList.remove('active');
        }

        function showStickerPanel() {
            const panel = document.getElementById('emojiStickerPanel');
            document.getElementById('emojiSection').style.display = 'none';
            document.getElementById('stickerSection').style.display = 'block';
            panel.classList.add('active');
            
            document.getElementById('stickerBtnMobile').classList.add('active');
            document.getElementById('emojiBtnMobile').classList.remove('active');
        }

        function hideEmojiStickerPanel() {
            document.getElementById('emojiStickerPanel').classList.remove('active');
            document.getElementById('emojiBtnMobile').classList.remove('active');
            document.getElementById('stickerBtnMobile').classList.remove('active');
        }

        function showMessageInput() {
            document.getElementById('globalMessageInput').classList.add('active');
            
            const messageInput = document.getElementById('mobileMessageInput');
            messageInput.readOnly = false;
            messageInput.disabled = false;
            messageInput.placeholder = 'Введите сообщение...';
            
            setTimeout(() => {
                messageInput.focus();
            }, 100);
        }
        
        function hideMessageInput() {
            document.getElementById('globalMessageInput').classList.remove('active');
            hideEmojiStickerPanel();
            
            const messageInput = document.getElementById('mobileMessageInput');
            messageInput.value = '';
            messageInput.disabled = true;
            messageInput.placeholder = '';
            
            document.getElementById('mobileSendBtn').disabled = true;
            resetTextareaHeight();
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function resetTextareaHeight() {
            const input = document.getElementById('mobileMessageInput');
            input.style.height = 'auto';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('mobileMessagesContainer');
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        async function handleMediaUpload(file) {
            if (!file || !currentChat) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const contact = users.find(u => u.username === currentChat);
                const chatId = getChatId(contact);
                
                const messageId = Date.now().toString();
                const fileType = file.type.startsWith('image/') ? 'image' : 'video';
                
                const message = {
                    id: messageId,
                    sender: currentUser.username,
                    type: fileType,
                    filename: file.name,
                    data: e.target.result,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now(),
                    read: false,
                    readBy: [],
                    isDeleted: false
                };
                
                // Добавляем информацию о реплае, если есть
                if (replyingToMessageId) {
                    message.replyTo = replyingToMessageId;
                    message.replyToMessage = {
                        id: replyingToMessage.id,
                        sender: replyingToMessage.sender,
                        text: replyingToMessage.text,
                        type: replyingToMessage.type
                    };
                }
                
                try {
                    await saveMessageToFirebase(message, chatId);
                    showNotification('Медиафайл отправлен!', 'success');
                    
                    // Сбрасываем реплай
                    if (replyingToMessageId) {
                        cancelReply();
                    }
                    
                } catch (error) {
                    console.error('Ошибка отправки медиафайла:', error);
                    showNotification('Ошибка отправки', 'error');
                }
            };
            
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>